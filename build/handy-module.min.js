/* Handy v1.0.0-dev | 2014-03-18 | zhengyinhui100@gmail.com */
$Define("M.AbstractModule","CM.AbstractView",function(e){var c=$HO.createClass();$HO.inherit(c,e,{useCache:!0,cache:function(){},init:function(){},reset:function(){},exit:function(){return!0}});return c});$Define("M.AbstractDao",function(){var e=$HO.createClass();$HO.extend(e.prototype,{ajax:function(c){this.beforeSend(c);c.error=$HF.intercept(this.error,c.error);c.success=$HF.intercept(this.success,c.success);return $.ajax(c)},beforeSend:$H.noop,error:$H.noop,success:$H.noop});return e});
$Define("M.AbstractNavigator","handy.base.Object",function(e){var c=e.createClass();e.extend(c.prototype,{navigate:function(){}});return c});
$Define("M.History","handy.base.HashChange",function(e){var c=$HO.createClass(),h=0;$HO.extend(c.prototype,{initialize:function(a,b){"function"==typeof a&&(b=a,a=null);this.error=b||$H.noop;this.key=a||"handy";this.states=[];e.listen($H.Function.bind(this.stateChange,this))},stateChange:function(){var a=this.getHashParam(),b=a.hKey,g=this.currentKey,d=this.states,c=d[g];if(b==g&&$HO.equals(a.param,c.param))return!1;(d=d[b])?a=d.onStateChange(d.param,!0):($D.warn("hisory state not found"),a=this.error("stateNotFound",
a));!0!=a?(a={hKey:g,param:c.param},this.saveHash(a)):this.currentKey=b},saveState:function(a){var b=this.currentKey=this.key+ ++h;this.states.push(b);this.states[b]=a;this.saveHash({hKey:b,param:a.param})},saveHash:function(a){$HU.setHash("#"+JSON.stringify(a))},getHashParam:function(){try{var a=$HU.getHash().replace("#","");return JSON.parse(a)}catch(b){$H.Debug.warn("History.getCurrentState:parse hash error:"+b.message)}},getCurrentState:function(){try{var a=this.getHashParam();return this.states[a.hKey]}catch(b){$H.Debug.warn("History.getCurrentState:parse hash error:"+
b.message)}},getPreState:function(){try{for(var a=this.getHashParam().hKey,b=this.states,g=b.length,d=0;d++;d<g)if(b[d]==a)return 0<d?b[b[--d]]:null}catch(c){$H.Debug.error("History.getPreState error:"+c.message,c)}},back:function(){var a=this.getPreState();if(a)a.onStateChange(a.param)}});return c});
$Define("M.ModuleManager",["M.History","CM.AbstractManager"],function(e,c){var h=$HO.createClass();$HO.inherit(h,c,{type:"module",_createMod:function(a){var b=this,c=a.modName;b.modules[c]={waiting:!0};$Require(b.defModPackage+c,function(d){d=new d({renderTo:a.renderTo||b.container,name:c,xtype:c,_id:b.generateId(),extCls:"js-module m-module",hidden:!0});b.modules[c]=d;$H.trigger("afterRender",d.getEl());b.requestMod==c&&b._showMod(d)})},_showMod:function(a){var b=this.modules[this.currentMod];if(!this.navigator||
!this.navigator.navigate(a,b,this))b&&b.hide(),a.show();b&&(b.isActive=!1);a.isActive=!0;this.currentMod=a.name},_destroy:function(a){a.destroy();delete this.modules[a.name]},initialize:function(a){var b=this;a&&(b.conf=a,$HO.extend(b,a),b.container=a.container?$(a.container):$(document.body));b.defModPackage+=".";b.history=new e(function(a,c){b.go(c.param)});b.modules={}},go:function(a,b){"string"==typeof a&&(a={modName:a});var c=a.modName,d=this.currentMod,e=this.modules,f=e[d];if(d==c)f.waiting||
f.reset();else{if(f&&!f.waiting)if(f._forceExit)f._forceExit=!1;else if(!1==f.exit())return!1;this.requestMod=c;(c=e[c])?c.useCache?(this._showMod(c),c.cache(a)):c.waiting||(this._destroy(c),this._createMod(a)):this._createMod(a);!0!=b&&this.history.saveState({onStateChange:$H.Function.bind(this.go,this),param:a});return!0}},back:function(a){a&&(this.modules[this.currentMod]._forceExit=!0);history.back()}});return h});
