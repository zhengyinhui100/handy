/* Handy v1.0.0-dev | 2014-03-26 | zhengyinhui100@gmail.com */
$Define("M.AbstractModule","CM.View",function(g){var e=$H.createClass();$H.inherit(e,g,{useCache:!0,cache:function(){},init:function(){},reset:function(){},exit:function(){return!0}});return e});$Define("M.AbstractNavigator","handy.base.Object",function(g){var e=$H.createClass();g.extend(e.prototype,{navigate:function(){}});return e});
$Define("M.History","handy.base.HashChange",function(g){var e=$H.createClass(),h=0;$H.extend(e.prototype,{initialize:function(a,b){"function"==typeof a&&(b=a,a=null);this.error=b||$H.noop;this.key=a||"handy";this.states=[];g.listen($H.Function.bind(this.stateChange,this))},stateChange:function(){var a=this.getHashParam(),b=a.hKey,c=this.currentKey,d=this.states,f=d[c];if(b==c&&$H.equals(a.param,f.param))return!1;(d=d[b])?a=d.onStateChange(d.param,!0):($D.warn("hisory state not found"),a=this.error("stateNotFound",
a));!0!=a?(a={hKey:c,param:f.param},this.saveHash(a)):this.currentKey=b},saveState:function(a){var b=this.currentKey=this.key+ ++h;this.states.push(b);this.states[b]=a;this.saveHash({hKey:b,param:a.param})},saveHash:function(a){$H.setHash("#"+$H.Json.stringify(a))},getHashParam:function(){try{var a=$H.getHash().replace("#","");return $H.parseJson(a)}catch(b){$H.Debug.warn("History.getCurrentState:parse hash error:"+b.message)}},getCurrentState:function(){try{var a=this.getHashParam();return this.states[a.hKey]}catch(b){$H.Debug.warn("History.getCurrentState:parse hash error:"+
b.message)}},getPreState:function(){try{for(var a=this.getHashParam().hKey,b=this.states,c=b.length,d=0;d++;d<c)if(b[d]==a)return 0<d?b[b[--d]]:null}catch(f){$H.Debug.error("History.getPreState error:"+f.message,f)}},back:function(){var a=this.getPreState();if(a)a.onStateChange(a.param)}});return e});
$Define("M.ModuleManager",["M.History","CM.AbstractManager"],function(g,e){var h=$H.createClass();$H.inherit(h,e,{type:"module",_createMod:function(a){var b=this,c=a.modName;b.modules[c]={waiting:!0};$Require(b.defModPackage+c,function(d){var f={renderTo:b.container,name:c,xtype:c,_id:b.generateId(),extCls:"js-module m-module",hidden:!0};$H.extend(f,a);d=new d(f);b.modules[c]=d;$H.trigger("afterRender",d.getEl());b.requestMod==c&&b._showMod(d)})},_showMod:function(a){var b=this.modules[this.currentMod];
if(!this.navigator||!this.navigator.navigate(a,b,this))b&&b.hide(),a.show();b&&(b.isActive=!1);a.isActive=!0;this.currentMod=a.name},_destroy:function(a){a.destroy();delete this.modules[a.name]},initialize:function(a){var b=this;a&&(b.conf=a,$H.extend(b,a),b.container=a.container?$(a.container):$(document.body));b.defModPackage+=".";b.history=new g(function(a,d){b.go(d.param)});b.modules={}},go:function(a,b){"string"==typeof a&&(a={modName:a});var c=a.modName,d=this.currentMod,f=this.modules,e=f[d];
if(d==c)e.waiting||e.reset();else{if(e&&!e.waiting)if(e._forceExit)e._forceExit=!1;else if(!1==e.exit())return!1;this.requestMod=c;(c=f[c])?c.useCache?(this._showMod(c),c.cache(a)):c.waiting||(this._destroy(c),this._createMod(a)):this._createMod(a);!0!=b&&this.history.saveState({onStateChange:$H.Function.bind(this.go,this),param:a});return!0}},back:function(a){a&&(this.modules[this.currentMod]._forceExit=!0);history.back()}});return h});
