/* Handy v1.0.0-dev | 2014-02-26 | zhengyinhui100@gmail.com */
$Define("m.AbstractModule","cm.AbstractView",function(e){var c=$HO.createClass();$HO.inherit(c,e,null,{useCache:!0,initialize:function(a){this.conf=a},cache:function(){},init:function(){},beforeRender:function(){},render:function(){},afterRender:function(){},reset:function(){},exit:function(){return!0},destroy:function(){this.getEl().remove()},getHtml:function(){if(!this.tmpl)return"";"string"!=typeof this.tmpl&&(this.tmpl=this.constructor.prototype.tmpl=this.tmpl.join(""));return $H.Template.tmpl({id:this.name,
tmpl:this.tmpl},this)}});return c});$Define("m.AbstractDao",function(){var e=$HO.createClass();$HO.extend(e,{ajax:function(c){this.beforeSend(c);c.error=$HF.intercept(this.error,c.error);c.success=$HF.intercept(this.success,c.success);return $.ajax(c)},beforeSend:$H.noop,error:$H.noop,success:$H.noop});return e});$Define("m.AbstractView",function(){var e=$HO.createClass();$HO.extend(e.prototype,{})});
$Define("m.AbstractNavigator","handy.base.Object",function(e){var c=e.createClass();e.extend(c.prototype,{navigate:function(){}});return c});
$Define("m.History","handy.base.HashChange",function(e){var c=$HO.createClass(),a=0;$HO.extend(c.prototype,{initialize:function(b,a){"function"==typeof b&&(a=b,b=null);this.error=a||$H.noop;this.key=b||"handy";this.states=[];e.listen($H.Function.bind(this.stateChange,this))},stateChange:function(){var b=this.getHashParam(),a=b.hKey,d=this.currentKey,g=this.states,c=g[d];if(a==d&&$HO.equals(b.param,c.param))return!1;(g=g[a])?b=g.onStateChange(g.param,!0):($D.warn("hisory state not found"),b=this.error("stateNotFound",
b));!0!=b?(b={hKey:d,param:c.param},this.saveHash(b)):this.currentKey=a},saveState:function(b){var h=this.currentKey=this.key+ ++a;this.states.push(h);this.states[h]=b;this.saveHash({hKey:h,param:b.param})},saveHash:function(b){$HU.setHash("#"+JSON.stringify(b))},getHashParam:function(){try{var b=$HU.getHash().replace("#","");return JSON.parse(b)}catch(a){$H.Debug.warn("History.getCurrentState:parse hash error:"+a.message)}},getCurrentState:function(){try{var b=this.getHashParam();return this.states[b.hKey]}catch(a){$H.Debug.warn("History.getCurrentState:parse hash error:"+
a.message)}},getPreState:function(){try{for(var b=this.getHashParam().hKey,a=this.states,d=a.length,c=0;c++;c<d)if(a[c]==b)return 0<c?a[a[--c]]:null}catch(e){$H.Debug.error("History.getPreState error:"+e.message,e)}},back:function(){var a=this.getPreState();if(a)a.onStateChange(a.param)}});return c});
$Define("m.ModuleManager","m.History",function(e){var c=$HO.createClass();$HO.extend(c.prototype,{_getModWrapper:function(a){a="modWrapper_"+a;var b=$("#"+a);0==b.length&&(b=$('<div id="'+a+'" class="js-module m-module"></div>'));return b},_createMod:function(a){var b=this,c=a.modName;b.modules[c]={waiting:!0};$Require(b.defModPackage+c,function(d){d=new d;d.name=c;d.mType=c;d.initParam=a;b.modules[c]=d;d.init(a);d.beforeRender();var e=b._getModWrapper(c);d._container=e;var f=d.renderTo?$(d.renderTo):
b.container;e.html(d.getHtml());f.append(e);$HL.fire("afterRender",e);d.render(e);b.currentMod==c&&b._showMod(d);d.afterRender()})},_showMod:function(a){if(this.navigator&&this.navigator.navigate(a,this))return!1;this._hideAll();a._container.show();a.isActive=!0},_hideAll:function(){var a=this.modules,b;for(b in a)a[b]._container.hide(),a[b].isActive=!1},_destroy:function(a){a.destroy();delete this.modules[a.name]},initialize:function(a){var b=this;a&&(b.conf=a,$HO.extend(b,a),b.container=a.container?
$(a.container):$(document.body));b.defModPackage+=".";b.history=new e(function(a,c){b.go(c.param)});b.modules={}},go:function(a,b){"string"==typeof a&&(a={modName:a});var c=a.modName,d=this.currentMod,e=this.modules,f=e[d];if(d==c)f.waiting||f.reset();else{if(f&&!f.waiting)if(f._forceExit)f._forceExit=!1;else if(!1==f.exit())return!1;(d=e[c])?d.useCache?(this._showMod(d),d.cache(a)):d.waiting||(this._destroy(d),this.currentMod=c,this._createMod(a)):this._createMod(a);!0!=b&&this.history.saveState({onStateChange:$H.Function.bind(this.go,
this),param:a});this.currentMod=c;return!0}},back:function(a){a&&(this.modules[this.currentMod]._forceExit=!0);history.back()}});return c});
