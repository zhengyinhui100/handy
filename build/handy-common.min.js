/* Handy v1.0.0-dev | 2014-04-24 | zhengyinhui100@gmail.com */
$Define("CM.AbstractEvents",function(){var h=$H.createClass();$H.extend(h.prototype,$H.Events);$H.extend(h.prototype,{_eventCache:{},_listenTo:[],_parseListenToEvents:function(f,b,c,e){var d=this,a=$H.toArray(arguments,3);return d._parseEvents(c,function(g){g.unshift(b);d[f].apply(d,g.concat(a))})},listenTo:function(f,b,c,e,d){if(!this._parseListenToEvents("listenTo",f,b,c,e,d)){"number"==typeof e&&(d=e,e=null);e=e||this;var a=this._delegateHandler(c,e);this._listenTo.push({target:f,name:b,delegation:a,
handler:c});f.on(b,a,e,d)}},unlistenTo:function(f,b,c){if(!this._parseListenToEvents("unlistenTo",f,b,c)){var e=this._listenTo,d="all"==f;$H.each(e,function(a,g){if(d||g.name==b&&g.handler==c&&g.target==f)g.target.off(g.name,g.delegation),e.splice(a,1)})}}});return h});
$Define("CM.DataStore",function(){var h=$H.createClass();$H.extend(h.prototype,{get:function(b,c){var e;if(e=f[b])return c?$H.where(e,c):e},push:function(b,c){"string"!=typeof b&&(c=b,b=null);var e=c.constructor.$ns;(f[e]||(f[e]=[])).push(c);b&&(f[b]||(f[b]=c))}});var f={};$S=$H.getSingleton(h);return h});
$Define("CM.AbstractDao","B.LocalStorage",function(h){var f=$H.createClass();$H.extend(f.prototype,{_ajaxMethodMap:{create:"POST",update:"POST",patch:"PATCH","delete":"DELETE",read:"GET"},_localMethodMap:{create:"setItem",update:"setItem",patch:"setItem","delete":"removeItem",read:"getItem"},ajax:function(b){this.beforeSend(b);b.error=$H.intercept(this.error,b.error);b.success=$H.intercept(this.success,b.success);return $.ajax(b)},beforeSend:$H.noop,error:$H.noop,success:$H.noop,get:function(){},
set:function(){},remove:function(){},sync:function(b,c,e){e=e||{};var d=e.storeType||"remote",a={type:"POST",dataType:"json"};e.url||(a.url=c.getUrl());if(null==e.data&&c&&("create"===b||"update"===b||"patch"===b))a.data=e.attrs||c.toJSON(e);if("remote"==d)a.url+="/"+b+".do",$H.extend(a,e),this.ajax(a);else h[this._localMethodMap[b]](a);c.trigger("request",c,e)}});return f});
$Define("CM.AbstractManager",function(){var h=$H.createClass();$H.extend(h.prototype,{_types:{},_all:{},type:"manager",registerType:function(f,b){this._types[f]=b;b.prototype.xtype=f},getClass:function(f){return $H.isClass(f)?f:this._types[f]||$H.ns(f)},register:function(f){this._all[f.getId()]=f},unregister:function(f){var b=this._all,c=f.getId();b[c]==f&&delete b[c]},eachInEl:function(f,b){var c=this;f.find(".js-"+c.type).each(function(e,d){d=$(d);var a=d.attr("id");(a=c.get(a))&&b(a)})},generateId:function(f,
b){var c=$H.expando+"_"+this.type+"_"+(f||$H.Util.getUuid());if(!0!=b&&this._all[c])$D.error("id\u91cd\u590d:"+c);else return c},get:function(f){var b=this._all;return b[f]||b[this.generateId(f,!0)]}});return h});
$Define("CM.ViewManager","CM.AbstractManager",function(h){var f=$H.createClass();$H.inherit(f,h,{type:"view",initialize:function(){var b=this;$H.on("afterRender",function(c,e){b.afterRender(e)});$H.on("removeEl",function(c,e){b.destroy(e)})},afterRender:function(b){this.eachInEl(b,function(b){b.afterRender()})},destroy:function(b){this.eachInEl(b,function(b){b.destroy(!0)})}});$V=$H.getSingleton(f);return f});
$Define("CM.View",["CM.ViewManager","CM.AbstractEvents","B.Template"],function(h,f){var b=/^(<[a-zA-Z]+)/,c=/^[^>]+class=/,e=/(class=")/,d=f.derive({xtype:"View",_placeholder:'<script id="" type="text/x-placeholder">\x3c/script>',autoRender:!0,renderBy:"append",listeners:[],items:[],tmpl:'<div><%=this.findHtml(">*")%></div>',children:[],_customEvents:"beforeRender render afterRender beforeShow show afterShow beforeHide hide afterHide beforeUpdate update afterUpdate beforeDestroy destroy afterDestroy add remove".split(" "),
_defaultEvents:"mousedown mouseup mouseover mousemove mouseenter mouseleave dragstart drag dragenter dragleave dragover drop dragend touchstart touchmove touchend touchcancel keydown keyup keypress click dblclick focus focusin focusout contextmenu change submit".split(" "),_applyArray:function(a,g){var d=this,b=arguments,c=b.callee.caller,e=c.$owner.prototype;0==b.length?(b=c.arguments,b=$H.toArray(b),a=c.$name,g=b.shift()):b=$H.toArray(b,2);return $H.isArr(g)?($H.each(g,function(g,c){e[a].apply(d,
[c].concat(b))}),!0):!1},_parseListenEvents:function(a,g){var d=this;return d._parseEvents(g.name,function(b){g.name=b[0];2==b.length&&(g.handler=b[1]);d[a].call(d,g)})},initialize:function(a){if(!this.inited){this.manager=this.constructor.manager||$H.getSingleton(h);var g=this.tmpl;$H.isFunc(g)||(this.tmpl=this.constructor.prototype.tmpl=$H.tmpl(g));this.doConfig(a);this.init&&this.init(a);this.parseItems();!1!=this.autoRender&&this.render();this.manager.register(this);this.inited=!0}},doConfig:function(a){var g=
this;g.initParam=a;"string"==typeof a&&(a={text:a});var d=a||{};$H.extend(g,d,{notCover:function(a,b){var c=$H.contains(g._customEvents,a);if($H.contains(g._defaultEvents,a))return g.listeners.push({name:a,handler:d[a]}),!0;if(c)return g.on(a,d[a]),!0;if("defItem"==a)return g[a]=$H.extend(g[a],b),!0;if("listener"==a)return g.listeners=g.listeners.concat($H.isArr(b)?b:[b]),!0;if("items"==a)return g.add(b),!0;if("extCls"==a&&g[a])return g[a]+=" "+b,!0;if("xtype"==a)return"View"==g[a]&&(g[a]="string"==
typeof b?b:b.$ns),!0}});(a=d.renderTo)?(a=$H.isFunc(a)?a.call(g):$H.isStr(a)&&0==a.indexOf(">")?g.parent.findEl(a.substring(1)):$(a),g.renderTo=a):g.renderTo=$(document.body)},getEl:function(){return this._container},getId:function(){return this._id||(this._id=this.manager.generateId(this.cid))},initHtml:function(){return this.tmpl(this)},getHtml:function(){var a=this.getId(),d;d="visibility"==this.displayMode?"visibility:hidden;":"display:none;";var m=this.initHtml(),n=c.test(m),y="js-"+this.manager.type+
" js-"+this.xtype+" "+this.extCls+" ";n&&(m=m.replace(e,"$1"+y));return m=m.replace(b,'$1 id="'+a+'" style="'+d+'"'+(n?"":' class="'+y+'"'))},findHtml:function(a){a=this.find(a);for(var d=[],b=0;b<a.length;b++)d.push(a[b].getHtml());return d.join("")},initStyle:function(){var a=this.getEl(),d=this.style||{};void 0!=this.width&&(d.width=this.width);void 0!=this.height&&(d.height=this.height);a.css(d)},beforeRender:function(){return this.trigger("beforeRender")},render:function(){if(!1==this.beforeRender())return!1;
this.trigger("render");var a=this.getHtml();this.renderTo[this.renderBy](a);this.afterRender()},afterRender:function(){if(this.rendered)return!1;this.callChild();this._container=$("#"+this.getId());this.rendered=!0;this.initStyle();!0!=this.notListen&&this.initListeners();this.disabled&&this.disable();this.trigger("afterRender");this.hidden||this.show()},beforeShow:function(){return this.trigger("beforeShow")},show:function(a,b){var c=this;if(!1==c.beforeShow()||c.showed||b&&c.hidden)return!1;if(!a&&
c.delayShow)setTimeout(function(){d.prototype.show.call(c,!0)},0);else{c.trigger("show");c.showed=!0;var n=c.getEl();"visibility"==c.displayMode?n.css({visibility:"visible"}):n.show();c.callChild([null,!0]);c.afterShow()}},afterShow:function(){this.trigger("afterShow")},beforeHide:function(){return this.trigger("beforeHide")},hide:function(){if(!1==this.beforeHide()||!this.showed)return!1;this.showed=!1;var a=this.getEl();"visibility"==this.displayMode?a.css({visibility:"hidden"}):a.hide();this.trigger("hide");
this.afterHide()},afterHide:function(){this.trigger("afterHide")},enable:function(){this.resume();this.getEl().removeClass("hui-disable").find("input,textarea,select").removeAttr("disabled")},disable:function(){this.suspend();this.getEl().addClass("hui-disable").find("input,textarea,select").attr("disabled","disabled")},getContent:function(a,b){b?!b instanceof d&&(b=this.find(b)[0]):b=this;return!1==a?b.children:b.getEl().html()},setContent:function(a,b){if(b)return!b instanceof d&&(b=this.find(b)[0]),
b.setContent(a);var c=this.getEl();c.contents().remove();if("string"==typeof a)c.html(a);else return this.add(a)},listen:function(a){if(!this._parseListenEvents("listen",a))if(this.listened){var d=a.name,b=a.context,c=a.times,e=a.target,f=a.custom,j=a.handler;$H.isFunc(e)&&(e=e.call(this));if(e||f)a=$H.removeUndefined([e,d,j,b,c]),this[f?"on":"listenTo"].apply(this,a);else{var f=this._listeners,c=a.el,e=a.method||"bind",l=a.selector,h=a.data,b=a.delegation=this._delegateHandler(j,b);$H.isFunc(c)&&
(c=c.call(this));$H.mobile()&&"click"==d&&(d="touchend");c=c?"string"==typeof c?this.findEl(c):c:this.getEl();if(l)if(h)c[e](l,d,h,b);else c[e](l,d,b);else if(h)c[e](d,h,b);else c[e](d,b);f.push(a)}}else this.listeners.push(a)},unlisten:function(a){if(!this._parseListenEvents("unlisten",a)){var d=a.name,b=a.handler;if(a.custom)this.off(d,b);else{var c=a.el,e="delegate"==a.method?"undelegate":"unbind";a=a.selector;var f;$H.mobile()&&"click"==d&&(d="touchend");for(var c=c?"string"==typeof c?this.findEl(c):
c:this.getEl(),j=this._listeners.length-1;0<=j;j--){var h=this._listeners[j];if(h.handler==b){f=h.delegation;this._listeners.splice(j,1);break}}if(a)c[e](a,d,f);else c[e](d,f)}}},initListeners:function(){if(this.listened)return!1;this.listened=!0;var a=this.listeners;this._listeners=[];for(var d=a.length-1;0<=d;d--)this.listen(a[d]);this.callChild()},clearListeners:function(){for(var a=this._listeners,d=a.length-1;0<=d;d--)this.unlisten(a[d]);this.off("all");this.unlistenTo("all");this.callChild()},
suspend:function(){if(this.isSuspend)return!1;this.isSuspend=!0;this.callChild()},resume:function(){if(!this.isSuspend)return!1;this.isSuspend=!1;this.callChild()},findEl:function(a){return this.getEl().find(a)},parentsEl:function(a){return this.getEl().parents(a)},each:function(a,d){for(var b=this.children,c=b.length,e,f=0;f<c;){e=b[f];e=d?a.apply(e,d):a(f,e);if(!1===e)break;c==b.length?f++:c=b.length}},match:function(a,d){if("*"==a)return!0;var b=d||this,c,e,f;a=a.replace(/#([^\s,\[]+)/,"[cid=$1]");
a=a.replace(/^([^\[]+)/,"[xtype=$1]");for(var j=/\[([^=|\!]+)(=|\!=)([^=]+)\]/g;c=j.exec(a);){e=c[1];f=c[2];c=c[3];if("false"==c||"true"==c)c=eval(c);if("="===f?b[e]!=c:b[e]==c)return!1}return!0},find:function(a,d){var b=this;d=d||[];if($H.isNum(a))d.push(b.children[a]);else if($H.isStr(a)){if(0<a.indexOf(","))return $H.each(a.split(","),function(a,c){d=d.concat(b.find(c))}),d;var c=0==a.indexOf(">"),e=a.replace(/^>?\s?/,""),f=e.search(/\s|>/),j;0<f&&(j=e.substring(f),e=e.substring(0,f));b.each(function(b,
m){m.match(e)&&(j?m.find(j,d):d.push(m));c||m.find(a,d)})}else if($H.isFunc(a)){var h=$H.isClass(a);b.each(function(b,c){(h&&c instanceof a||!h&&a(c))&&d.push(c);c.find(a,d)})}return d},parents:function(a){for(var d=this;d.parent;)if(d=d.parent,a&&this.match(a,d))return d;return a||d===this?null:d},index:function(){var a=this,d=a.parent;if(d){var b;d.each(function(d,c){if(c==a)return b=d,!1});return b}return null},callChild:function(a,d){0!=this.children.length&&(a&&"string"!=typeof a&&(d=a,a=null),
a=a||arguments.callee.caller.$name,this.each(function(b,c){d?c[a].apply(c,d):c[a].call(c)}))},add:function(a,b){if(!this._applyArray()){var c=void 0==b;if(this.startParseItems){if(a instanceof d)a.parent=this;else{this.defItem&&$H.extend(a,this.defItem,{notCover:!0});this.parseItem(a);var e=this.manager.getClass(a.xtype);e?(a.renderTo||(this.inited?a.renderTo=this.getEl():a.autoRender=!1),a.parent=this,a=new e(a)):$D.error("xtype:"+a.xtype+"\u672a\u627e\u5230")}e=this.children;c?e.push(a):e.splice(b,
0,a);this.trigger("add",a);return a}e=this.items;c?e.push(a):e.splice(b,0,a)}},remove:function(a){if(!this._applyArray()){var b=this.children,c=!1,e;if($H.isNum(a))e=a,a=b[e];else if($H.isStr(a)||$H.isFunc(a)){a=this.find(a);for(var f=0,h=a.length;f<h;f++){if(!1==this.remove(a[f]))return!1;c=!0}}else if(a instanceof d)if(a.parent==this){f=0;for(h=b.length;f<h;f++)if(b[f]==a){e=f;break}}else return a.parent.remove(a);void 0!=e&&!1!=a.destroy(!0)&&(b.splice(e,1),c=!0);this.trigger("remove",a);return c}},
parseItem:function(){},parseItems:function(){this.startParseItems=!0;var a=this.items;if(a)for(var a=$H.isArr(a)?a:[a],d=0,b=a.length;d<b;d++)this.add(a[d])},beforeUpdate:function(){return this.trigger("beforeUpdate")},update:function(a,d){if(!1==this.beforeUpdate())return!1;a=a||{};var b=this.parent,c=$("<span></span>").insertBefore(this.getEl());d||(void 0==a.autoRender&&(a.autoRender=!0),a=$H.extend(a,this.initParam,{notCover:!0}));a=$H.extend(a,{xtype:this.xtype,renderBy:"replaceWith",renderTo:c},
{notCover:["xtype"]});if(!a.cid||a.cid==this.cid)a._id=this._id;if(b){var e=this.index();if(!1==b.remove(this))return c.remove(),!1;b=b.add(a,e)}else{if(!1==this.destroy())return c.remove(),!1;b=new this.constructor(a)}this.trigger("update",b);this.afterUpdate(b);return b},replace:function(a){return this.update(a,!0)},afterUpdate:function(a){this.trigger("afterUpdate",a)},beforeDestroy:function(){return this.trigger("beforeDestroy")},destroy:function(a){if(!1==this.beforeDestroy())return!1;if(!this.destroyed)return this.callChild(),
this.trigger("destroy"),this.clearListeners(),this.getEl().remove(),this.destroyed=!0,!a&&this.parent&&this.parent.remove(this),this.manager.unregister(this),delete this.initParam,delete this._container,delete this.renderTo,delete this._listeners,delete this.children,this.afterDestroy(),!0},afterDestroy:function(){this.trigger("afterDestroy")}},{extend:function(a){var d=this.prototype;$H.extend(d,a,{notCover:function(b){if($H.contains(["_customEvents","listeners"],b))return d[b]=(a[b]||[]).concat(d[b]||
[]),!0;if("xtype"==b||"constructor"==b)return!0}})},html:function(a){return(new this($H.extend({autoRender:!1},a))).getHtml()}});return d});
$Define("CM.Model",["CM.AbstractDao","CM.AbstractEvents"],function(h,f){return f.derive({idAttribute:"id",_pending:!1,_validate:function(b,c){if(!c.validate||!this.validate)return!0;b=$H.extend({},this._attributes,b);var e=this.validationError=this.validate(b,c)||null;if(!e)return!0;this.trigger("invalid",this,e,$H.extend(c,{validationError:e}));return!1},_initDepFields:function(){var b=this.fields,c,e;for(e in b)if(c=b[e],c=c.depends)for(var d=0;d<c.length;d++)this.on("change:"+c[d],$H.bind(this.set,
this,e,null,null))},_parseFields:function(b){var c;if(!(c=this.fields))return b;var e,d,a,g={},f;for(f in b){d=b[f];if(e=c[f]){a=$H.isObj(e)?e.type:e;if(e=e.parse)d=e.apply(this,[d,b]);$H.isStr(a)&&("Date"==a?d=$H.parseDate(d):0<a.indexOf(".")&&(a=$H.ns(a)));$H.isClass(a)&&!(d instanceof a)&&(d=new a(d),d.on("all",$H.bind(this._onAttrEvent,this,f)))}g[f]=d}return g},_onAttrEvent:function(b,c){if(!("invalid"==c||"sync"==c)){var e=this.get(b);0!=c.indexOf("change:")&&(this.trigger("change:"+b,this,
e),this.trigger("change",this))}},initialize:function(b,c){this.dao=this.dao||$H.getSingleton(h);this._initDepFields();var e=b||{};c||(c={});this.cid=$H.Util.getUuid();this._attributes={};c.collection&&(this.collection=c.collection);c.parse&&(e=this.parse(e,c)||{});e=$H.extend(e,$H.Util.result(this,"defaults"),{notCover:!0});this.set(e,c);this._changed={};$S.push(this)},toJSON:function(){return $H.clone(this._attributes)},sync:function(b,c,e){return this.dao.sync(b,c,e)},get:function(b){return this._attributes[b]},
escape:function(b){return $H.String.escapeHTML(this.get(b))},has:function(b){b=this.get(b);return null!=b&&void 0!=b},set:function(b,c,e){var d;"object"===typeof b?(d=b,e=c):(d={})[b]=c;e||(e={});d=this._parseFields(d);if(!this._validate(d,e))return!1;var a=e.unset;b=e.silent;var g=[],f=this._changing;this._changing=!0;f||(this._previousAttributes=$H.Object.clone(this._attributes),this._changed={});var n=this._attributes,h=this._previousAttributes;this.idAttribute in d&&(this.id=d[this.idAttribute]);
for(var k in d)c=d[k],$H.equals(n[k],c)||g.push(k),$H.equals(h[k],c)?delete this._changed[k]:this._changed[k]=c,a?delete n[k]:n[k]=c;if(!b){g.length&&(this._pending=e);c=0;for(d=g.length;c<d;c++)this.trigger("change:"+g[c],this,n[g[c]],e)}if(f)return this;if(!b)for(;this._pending;)e=this._pending,this._pending=!1,this.trigger("change",this,e);this._changing=this._pending=!1;return this},unset:function(b,c){c=c||{};c.unset=!0;return this.set(b,void 0,c)},clear:function(b){var c={},e;for(e in this._attributes)c[e]=
void 0;b=b||{};b.unset=!0;return this.set(c,b)},hasChanged:function(b){var c=this._changed;return null==b?!$H.isEmpty(c):$H.contains(c,b)},changedAttrbutes:function(b){if(!b)return this.hasChanged()?$H.clone(this._changed):!1;var c,e=!1,d=this._changing?this._previousAttributes:this._attributes,a;for(a in b)if(!$H.equals(d[a],c=b[a]))(e||(e={}))[a]=c;return e},previous:function(b){return null==b||!this._previousAttributes?null:this._previousAttributes[b]},fetch:function(b){var c=this;b=b?$H.clone(b):
{};void 0===b.parse&&(b.parse=!0);var e=b.success,d=b.beforeSet;b.success=function(a){if(!(d&&!1==d(c,a,b))){if(!c.set(c.parse(a,b),b))return!1;e&&e(c,a,b);c.trigger("sync",c,a,b)}};c.sync("read",c,b)},save:function(b,c,e){var d=this,a;null==b||"object"===typeof b?(a=b,e=c):(a={})[b]=c;$H.isFunc(e)&&(e={success:e});e=$H.extend({validate:!0},e);if(a&&e.now){if(!d.set(a,e))return!1}else if(!d._validate(a,e))return!1;void 0===e.parse&&(e.parse=!0);var g=e.success;e.success=function(b){var c=d.parse(b,
e);e.now||(c=$H.extend(a||{},c));if($H.isObj(c)&&!d.set(c,e))return!1;g&&g(d,b,e);d.trigger("sync",d,b,e)};b=d.isNew()?"create":e.update?"update":"patch";if("patch"===b){c=d.changedAttrbutes(a);if(!c){g&&g(d,e);return}e.attrs=c}else c=$H.extend({},d._attributes),e.attrs=$H.extend(c,a);d.sync(b,d,e)},destroy:function(b){var c=this;b=b?$H.clone(b):{};var e=b.success,d=function(){c.trigger("destroy",c,c.collection,b);c.off("all")};b.success=function(a){(!b.now||c.isNew())&&d();e&&e(c,a,b);c.isNew()||
c.trigger("sync",c,a,b)};if(c.isNew())return b.success(),!1;c.sync("delete",c,b);b.now&&d()},getUrl:function(){var b=$H.result(this,"url")||$H.result(this.collection,"url");b||$D.error(Error("\u5fc5\u987b\u8bbe\u7f6e\u4e00\u4e2aurl\u5c5e\u6027\u6216\u8005\u51fd\u6570"));return this.isNew()?b:b.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(b){return b.code&&b.data?b.data:b},clone:function(){return new this.constructor(this._attributes)},isNew:function(){return void 0==this.id},
isValid:function(b){return this._validate({},$H.extend(b||{},{validate:!0}))}})});
$Define("CM.Collection",["CM.AbstractDao","CM.AbstractEvents","CM.Model"],function(h,f,b){var c=f.derive({_reset:function(){this.length=0;this._models=[];this._byId={}},_prepareModel:function(d,a){if(d instanceof b)return d;a=a?$H.clone(a):{};a.collection=this;var c=$S.get(this.model.$ns,{id:a.id});if(c=c&&c[0])return c.set(d,a),c;c=new this.model(d,a);if(!c.validationError)return c;this.trigger("invalid",this,c.validationError,a);return!1},_addReference:function(d){this._byId[d.cid]=d;null!=d.id&&
(this._byId[d.id]=d);d.collection||(d.collection=this);d.on("all",this._onModelEvent,this)},_removeReference:function(d){this===d.collection&&delete d.collection;d.off("all",this._onModelEvent,this)},_onModelEvent:function(d,a,b,c){("add"===d||"remove"===d)&&b!==this||("destroy"===d&&this.remove(a,c),a&&d==="change:"+a.idAttribute&&(delete this._byId[a.previous(a.idAttribute)],null!=a.id&&(this._byId[a.id]=a)),this.trigger.apply(this,arguments))},initialize:function(d,a){this.dao=this.dao||$H.getSingleton(h);
a||(a={});a.model&&(this.model=a.model);a.url&&(this.url=a.url);void 0!==a.comparator&&(this.comparator=a.comparator);this._reset();d&&this.reset(d,$H.extend({silent:!0},a))},toJSON:function(d){return $H.map(this._models,function(a){return a.toJSON(d)})},sync:function(d,a,b){return this.dao.sync(d,a,b)},add:function(d,a){a=$H.extend({add:!0,remove:!1,merge:!1},a);return this.set(d,a)},remove:function(d,a){var b=!$H.isArr(d);d=b?[d]:$H.clone(d);a||(a={});var c,e,f,h;c=0;for(e=d.length;c<e;c++)if(h=
d[c]=this.get(d[c]))delete this._byId[h.id],delete this._byId[h.cid],f=this.indexOf(h),this._models.splice(f,1),this.length--,a.silent||(a.index=f,h.trigger("remove",h,this,a)),this._removeReference(h,a);return b?d[0]:d},set:function(d,a){if(d){a=$H.extend({add:!0,remove:!0,merge:!0},a);a.parse&&(d=this.parse(d,a));var c=!$H.isArr(d),e=c?d?[d]:[]:$H.clone(d),f,h,k,j,l,r,s,u=a.at,A=this.model,v=this.comparator&&null==u&&!1!==a.sort,B="string"==typeof this.comparator?this.comparator:null,p=[],w=[],
t={},z=a.add,C=a.merge,x=a.remove,q=!v&&z&&x?[]:!1;f=0;for(h=e.length;f<h;f++){l=e[f]||{};k=l instanceof b?j=l:l[A.prototype.idAttribute||"id"];if(r=this.get(k))x&&(t[r.cid]=!0),C&&(l=l===j?j.attributes:l,a.parse&&(l=r.parse(l,a)),r.set(l,a),v&&(!s&&r.hasChanged(B))&&(s=!0)),e[f]=r;else if(z){a.id=k;j=e[f]=this._prepareModel(l,a);if(!j)continue;p.push(j);this._addReference(j,a)}j=r||j;q&&(j.isNew()||!t[j.id])&&q.push(j);t[j.id]=!0}if(x){f=0;for(h=this.length;f<h;++f)t[(j=this._models[f]).cid]||w.push(j);
w.length&&this.remove(w,a)}if(p.length||q&&q.length)if(v&&(s=!0),this.length+=p.length,null!=u){f=0;for(h=p.length;f<h;f++)this._models.splice(u+f,0,p[f])}else{q&&(this._models.length=0);k=q||p;f=0;for(h=k.length;f<h;f++)this._models.push(k[f])}s&&this.sort({silent:!0});if(!a.silent){f=0;for(h=p.length;f<h;f++)(j=p[f]).trigger("add",j,this,a);(s||q&&q.length)&&this.trigger("sort",this,a)}return c?e[0]:e}},each:function(d){$H.each(this._models,d)},reset:function(d,a){a||(a={});for(var b=0,c=this._models.length;b<
c;b++)this._removeReference(this._models[b],a);a.previousModels=this._models;this._reset();d&&(d=this.add(d,$H.extend({silent:!0},a)));a.silent||this.trigger("reset",this,a);return d},push:function(b,a){return this.add(b,$H.extend({at:this.length},a))},pop:function(b){var a=this.at(this.length-1);this.remove(a,b);return a},unshift:function(b,a){return this.add(b,$H.extend({at:0},a))},shift:function(b){var a=this.at(0);this.remove(a,b);return a},slice:function(){return Array.prototype.slice.apply(this._models,
arguments)},get:function(b){return null==b?void 0:this._byId[b]||this._byId[b.id]||this._byId[b.cid]},size:function(){return this.length},at:function(b){return this._models[b]},where:function(b,a){return $H.isEmpty(b)?a?void 0:[]:this[a?"find":"filter"](function(a){for(var c in b)if(b[c]!==a.get(c))return!1;return!0})},findWhere:function(b){return this.where(b,!0)},sort:function(b){this.comparator||$D.error(Error("\u6ca1\u6709\u6bd4\u8f83\u5668"));b||(b={});"string"==typeof this.comparator||1===this.comparator.length?
this._models=this.sortBy(this.comparator,this):this._models.sort($H.Function.bind(this.comparator,this));b.silent||this.trigger("sort",this,b);return this},pluck:function(b){return $H.invoke(this._models,"get",b)},getUrl:function(){return this.url},fetch:function(b){var a=this;b=b?$H.clone(b):{};void 0===b.parse&&(b.parse=!0);var c=b.success,e=b.beforeSet;b.success=function(f){e&&!1==e(a,f,b)||(a[b.reset?"reset":b.add?"add":"set"](f,b),c&&c(a,f,b),a.trigger("sync",a,f,b))};return a.sync("read",a,
b)},create:function(b,a){var c=this;a=a?$H.clone(a):{};if(!(b=c._prepareModel(b,a)))return!1;a.now&&c.add(b,a);var e=a.success;a.success=function(b,d){a.now||c.add(b,a);e&&e(b,d,a)};b.save(null,a);return b},parse:function(b){return b.data},clone:function(){return new this.constructor(this._models)}}),e=$H.Array;$H.each("map some every find filter invoke indexOf".split(" "),function(b,a){c.prototype[a]=function(){var b=Array.prototype.slice.call(arguments);b.unshift(this._models);return e[a].apply(e,
b)}});$H.each(["sortBy","groupBy","countBy"],function(b){c.prototype[b]=function(a,c){var f=$H.isFunc(a)?a:function(b){return b.get(a)};return e[b](this._models,f,c)}});return c});
