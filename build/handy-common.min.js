/* Handy v1.0.0-dev | 2014-03-21 | zhengyinhui100@gmail.com */
$Define("CM.AbstractEvents",function(){var h=$H.createClass();$H.extend(h.prototype,$H.Events);$H.extend(h.prototype,{_eventCache:{},_listenTo:[],_parseListenToEvents:function(e,c,d,a){var b=this,g=$H.toArray(arguments,3);return b._parseEvents(d,function(a){a.unshilft(c);b[e].apply(b,a.concat(g))})},listenTo:function(e,c,d,a,b){if(!this._parseListenToEvents("listenTo",e,c,d,a,b)){"number"==typeof a&&(b=a,a=null);var g=this._delegateHandler(d,a);this._listenTo.push({target:e,name:c,delegation:g,handler:d});
e.on(c,g,a||this,b)}},unlistenTo:function(e,c,d){if(!this._parseListenToEvents("unlistenTo",e,c,d))for(var a=this._listenTo,b="all"==e,g,r=0,f=a.length;r<f;r++)if(g=a[r],b||g.name==c&&g.handler==d&&g.target==e)e.off(c,g.delegation),a.splice(r,1)}});return h});
$Define("CM.AbstractDao","B.LocalStorage",function(h){var e=$H.createClass();$H.extend(e.prototype,{ajax:function(c){this.beforeSend(c);c.error=$H.intercept(this.error,c.error);c.success=$H.intercept(this.success,c.success);return $.ajax(c)},beforeSend:$H.noop,error:$H.noop,success:$H.noop,get:function(){},set:function(){},remove:function(){},sync:function(c){c=c||{};var d=c.type||"remote";c=c.param;if("remote"==d)this.ajax(c);else h[d+"Item"](c)}});return e});
$Define("CM.AbstractManager",function(){var h=$H.createClass();$H.extend(h.prototype,{_types:{},_all:{},type:"manager",registerType:function(e,c){this._types[e]=c;c.prototype.xtype=e},getClass:function(e){return this._types[e]},register:function(e){this._all[e.getId()]=e},unregister:function(e){var c=this._all,d=e.getId();c[d]==e&&delete c[d]},eachInEl:function(e,c){var d=this;e.find(".js-"+d.type).each(function(a,b){b=$(b);var g=b.attr("id");(g=d.get(g))&&c(g)})},generateId:function(e,c){var d=$H.expando+
"_"+this.type+"_"+(e||$H.Util.getUuid());if(!0!=c&&this._all[d])$D.error("id\u91cd\u590d:"+d);else return d},get:function(e){var c=this._all;return c[e]||c[this.generateId(e,!0)]}});return h});
$Define("CM.ViewManager","CM.AbstractManager",function(h){var e=$H.createClass();$H.inherit(e,h,{type:"view",initialize:function(){var c=this;$H.on("afterRender",function(d){c.afterRender(d)});$H.on("removeEl",function(d){c.destroy(d)})},afterRender:function(c){this.eachInEl(c,function(c){c.afterRender()})},destroy:function(c){this.eachInEl(c,function(c){c.destroy(!0)})}});$V=$H.getSingleton(e);return e});
$Define("CM.View",["CM.ViewManager","CM.AbstractEvents"],function(h,e){var c=/^(<[a-zA-Z]+)/,d=/^[^>]+class=/,a=/(class=")/,b=e.extend({xtype:"View",autoRender:!0,renderBy:"append",children:[],_customEvents:"beforeRender render afterRender beforeShow show afterShow beforeHide hide afterHide beforeUpdate update afterUpdate beforeDestroy destroy afterDestroy".split(" "),_defaultEvents:"mousedown mouseup mouseover mousemove mouseenter mouseleave dragstart drag dragenter dragleave dragover drop dragend touchstart touchmove touchend touchcancel keydown keyup keypress click dblclick focus focusin focusout contextmenu change submit".split(" "),
_parseListenEvents:function(g,a){var b=this;return b._parseEvents(a.name,function(c){a.name=c[0];2==c.length&&(a.handler=c[0]);b[g].call(b,a)})},initialize:function(g){this.manager=this.constructor.manager||$H.getSingleton(h);this.doConfig(g);this.parseItems();!1!=this.autoRender&&this.render();this.manager.register(this)},doConfig:function(g){var a=this;a.params=g;a.settings=$H.clone(g);a.renderTo=g.renderTo?$(g.renderTo):$(document.body);var b=a.listeners||[];g.listeners&&(b=b.concat(g.listeners));
a._listeners=b;$H.extend(a,g,{notCover:function(b){var c=a[b],f=$H.contains(a._customEvents,b);if($H.contains(a._defaultEvents,b))a._listeners.push({name:b,handler:g[b]});else if(f)a.on(b,g[b]);if(null!=c&&"object"==typeof c||$H.isFunction(c))return!0}});g.defItem&&$H.extend(a.defItem,g.defItem)},getEl:function(){return this._container},getId:function(){return this._id||(this._id=this.manager.generateId(this.cid))},initHtml:function(){"string"!=typeof this.tmpl&&(this.tmpl=this.constructor.prototype.tmpl=
this.tmpl.join(""));return $H.Template.tmpl({id:this.xtype,tmpl:this.tmpl},this)},getHtml:function(){var g=this.getId(),b;b="visibility"==this.displayMode?"visibility:hidden;":"display:none;";var f=this.initHtml(),k=d.test(f),l="js-"+this.manager.type+" "+this.extCls+" ";k&&(f=f.replace(a,"$1"+l));return f=f.replace(c,'$1 id="'+g+'" style="'+b+'"'+(k?"":' class="'+l+'"'))},findHtml:function(a){a=">*"==a?this.children:this.find(a);for(var b=[],c=0;c<a.length;c++)b.push(a[c].getHtml());return b.join("")},
initStyle:function(){var a=this.getEl(),b=this.style||{};void 0!=this.width&&(b.width=this.width);void 0!=this.height&&(b.height=this.height);a.css(b)},beforeRender:function(){return this.trigger("beforeRender")},render:function(){if(!1==this.beforeRender())return!1;this.trigger("render");var a=this.getHtml();this.renderTo[this.renderBy](a);this.afterRender()},afterRender:function(){if(this.rendered)return!1;this.callChild();this._container=$("#"+this.getId());this.rendered=!0;this.initStyle();!0!=
this.notListen&&this.initListeners();this.disabled&&this.disable();this.trigger("afterRender");this.hidden||this.show()},beforeShow:function(){return this.trigger("beforeShow")},show:function(a,c){var f=this;if(!1==f.beforeShow()||f.showed||c&&f.hidden)return!1;if(!a&&f.delayShow)setTimeout(function(){b.prototype.show.call(f,!0)},0);else{f.trigger("show");f.showed=!0;var k=f.getEl();"visibility"==f.displayMode?k.css({visibility:"visible"}):k.show();f.callChild([null,!0]);f.afterShow()}},afterShow:function(){this.trigger("afterShow")},
beforeHide:function(){return this.trigger("beforeHide")},hide:function(){if(!1==this.beforeHide()||!this.showed)return!1;this.showed=!1;var a=this.getEl();"visibility"==this.displayMode?a.css({visibility:"hidden"}):a.hide();this.trigger("hide");this.afterHide()},afterHide:function(){this.trigger("afterHide")},enable:function(){this.resume();this.getEl().removeClass("hui-disable").find("input,textarea,select").removeAttr("disabled")},disable:function(){this.suspend();this.getEl().addClass("hui-disable").find("input,textarea,select").attr("disabled",
"disabled")},listen:function(a){if(!this._parseListenEvents("listen",a)){var b=a.name,c=a.context,k=a.times,d=a.target,j=a.custom,e=a.handler;if(d||j)a=$H.removeUndefined([d,b,e,c,k]),this[j?"on":"listenTo"].apply(this,a);else if(a.custom)this.on.apply(this,b,e,c,k);else{var j=this._listeners,k=a.el,d=a.method||"bind",h=a.selector,m=a.data,c=a.delegation=this._delegateHandler(e,c);$H.mobile()&&"click"==b&&(b="touchend");k=k?"string"==typeof k?this.find(k):k:this.getEl();if(h)if(m)k[d](h,b,m,c);else k[d](h,
b,c);else if(m)k[d](b,m,c);else k[d](b,c);j.push(a)}}},unlisten:function(a){if(!this._parseListenEvents("unlisten",a)){var b=a.name,c=a.handler;if(a.custom)this.off(b,c);else{var d=a.el,l="delegate"==a.method?"undelegate":"unbind";a=a.selector;var j;$H.mobile()&&"click"==b&&(b="touchend");for(var d=d?"string"==typeof d?this.find(d):d:this.getEl(),e=this._listeners.length-1;0<=e;e--){var h=this._listeners[e];if(h.handler==c){j=h.delegation;this._listeners.splice(e,1);break}}if(a)d[l](a,b,j);else d[l](b,
j)}}},initListeners:function(){if(this.listened)return!1;this.listened=!0;var a=this._listeners;this._listeners=[];for(var b=a.length-1;0<=b;b--)this.listen(a[b]);this.callChild()},clearListeners:function(){for(var a=this._listeners,b=a.length-1;0<=b;b--)this.unlisten(a[b]);this.off("all");this.callChild()},suspend:function(){if(this.isSuspend)return!1;this.isSuspend=!0;this.callChild()},resume:function(){if(!this.isSuspend)return!1;this.isSuspend=!1;this.callChild()},each:function(a,b){for(var c=
this.children,d=c.length,l,e=0;e<d;){l=c[e];l=b?a.apply(l,b):a(e,l);if(!1===l)break;d==c.length?e++:d=c.length}},match:function(a,b){if("*"==a)return!0;var c=b||this,d,e,j;a=a.replace(/^([^\[]+)/,'[xtype="$1"]');for(var h=/\[([^=|\!]+)(=|\!=)([^=]+)\]/g;d=h.exec(a);)if(e=d[1],j=d[2],d=eval(d[3]),"="===j?c[e]!=d:c[e]==d)return!1;return!0},find:function(a,b){var c=this;if(0!=a.indexOf("$"))return c.getEl().find(a);b=b||[];if(0<a.indexOf(","))return $H.each(a.split(","),function(a,g){b=b.concat(c.find(g))}),
b;var d=1==a.indexOf(">"),e=a.replace(/^\$>?\s?/,""),j=e.search(/\s|>/),h;0<j&&(h=e.substring(j),e=e.substring(0,j));c.each(function(c,f){f.match(e)&&(h?f.find("$"+h,b):b.push(f));d||f.find(a,b)});return b},parents:function(a){if(a&&0!=a.indexOf("$"))return this.getEl().parents(a);for(var b=this;b.parent;)if(b=b.parent,a&&this.match(a,b))return b;return a||b===this?null:b},index:function(){var a=this,b=a.parent;if(b){var c;b.each(function(b,d){if(d==a)return c=b,!1});return c}return null},callChild:function(a,
b){0!=this.children.length&&(a&&"string"!=typeof a&&(b=a,a=null),a=a||arguments.callee.caller.$name,this.each(function(c,d){b?d[a].apply(d,b):d[a].call(d)}))},add:function(a){this.children.push(a);a.parent=this},remove:function(a){for(var b=this.children,c=!1,d=0,e=b.length;d<e;d++)b[d]==a&&(b.splice(d,1),a.destroy(),c=!0);return c},addItem:function(a){var b=this.settings,c=b.items;c?$H.isArray(c)||(b.items=[c]):b.items=[];b.items.push(a)},parseItem:function(){},parseItems:function(){var a=this.settings.items;
if(a)for(var a=a.length?a:[a],b=0,c=a.length;b<c;b++){var d=a[b];this.defItem&&$H.extend(d,this.defItem,{notCover:!0});this.parseItem(d);var e=this.manager.getClass(d.xtype);e?(d.renderTo||(d.autoRender=!1),d=new e(d),this.add(d)):$D.error("xtype:"+d.xtype+"\u672a\u627e\u5230")}},beforeUpdate:function(){return this.trigger("beforeUpdate")},update:function(a){var b=this;if(!1==b.beforeUpdate())return!1;var c=b.parent;a=$H.extend({renderBy:"before",renderTo:b.getEl()},a);c&&(a=$H.extend(c.defItem,a),
c.parseItem(a));if(!a.cid||a.cid==b.cid)a._id=b._id;var d=new b.constructor(a);c&&(d.parent=c,c.each(function(a,g){if(g==b)return c.children.splice(a,1,d),!1}));b.destroy();b.trigger("update");b.afterUpdate(d);return d},afterUpdate:function(a){this.trigger("afterUpdate",a)},beforeDestroy:function(){return this.trigger("beforeDestroy")},destroy:function(){if(!1==this.beforeDestroy()||this.destroyed)return!1;this.callChild();this.trigger("destroy");this.clearListeners();this.getEl().remove();this.destroyed=
!0;this.parent&&this.parent.remove(this);this.manager.unregister(this);delete this.params;delete this.settings;delete this._container;delete this.renderTo;delete this._listeners;delete this.children;this.afterDestroy()},afterDestroy:function(){this.trigger("afterDestroy")}},{extend:function(a){var b=this.prototype;$H.extend(b,a,{notCover:function(c){if($H.contains(["_customEvents","listeners"],c))return b[c]=(a[c]||[]).concat(b[c]||[]),!0;if("xtype"==c||"constructor"==c)return!0}})},html:function(a){return(new this($H.extend({autoRender:!1},
a))).getHtml()}});return b});
$Define("CM.Model",["CM.AbstractDao","CM.AbstractEvents"],function(h,e){return e.extend({_pending:!1,idAttribute:"id",_validate:function(c,d){if(!d.validate||!this.validate)return!0;c=$H.extend({},this.attributes,c);var a=this.validationError=this.validate(c,d)||null;if(!a)return!0;this.trigger("invalid",this,a,$H.extend(d,{validationError:a}));return!1},initialize:function(c,d){this.dao=this.dao||$H.getSingleton(h);var a=c||{};d||(d={});this.cid=$H.Util.getUuid();this.attributes={};d.collection&&
(this.collection=d.collection);d.parse&&(a=this.parse(a,d)||{});a=$H.extend(a,$H.Util.result(this,"defaults"),{notCover:!0});this.set(a,d);this.changed={}},toJson:function(){return $H.clone(this.attributes)},sync:function(c,d,a){return this.dao.sync.apply(this,arguments)},get:function(c){return this.attributes[c]},escape:function(c){return $H.String.escapeHTML(this.get(c))},has:function(c){c=this.get(c);return null!=c&&void 0!=c},set:function(c,d,a){var b;"object"===typeof c?(b=c,a=d):(b={})[c]=d;
a||(a={});if(!this._validate(b,a))return!1;var g=a.unset;c=a.silent;var e=[],f=this._changing;this._changing=!0;f||(this._previousAttributes=$H.Object.clone(this.attributes),this.changed={});var k=this.attributes,l=this._previousAttributes;this.idAttribute in b&&(this.id=b[this.idAttribute]);for(var j in b)d=b[j],$H.equals(k[j],d)||e.push(j),$H.equals(l[j],d)?delete this.changed[j]:this.changed[j]=d,g?delete k[j]:k[j]=d;if(!c){e.length&&(this._pending=a);d=0;for(b=e.length;d<b;d++)this.trigger("change:"+
e[d],this,k[e[d]],a)}if(f)return this;if(!c)for(;this._pending;)a=this._pending,this._pending=!1,this.trigger("change",this,a);this._changing=this._pending=!1;return this},unset:function(c,d){d=d||{};d.unset=!0;return this.set(c,void 0,d)},clear:function(c){var d={},a;for(a in this.attributes)d[a]=void 0;c=c||{};c.unset=!0;return this.set(d,c)},hasChanged:function(c){var d=this.changed;return null==c?!$H.isEmpty(d):$H.contains(d,c)},changedAttrbutes:function(c){if(!c)return this.hasChanged()?$H.clone(this.changed):
!1;var d,a=!1,b=this._changing?this._previousAttributes:this.attributes,g;for(g in c)if(!$H.equals(b[g],d=c[g]))(a||(a={}))[g]=d;return a},previous:function(c){return null==c||!this._previousAttributes?null:this._previousAttributes[c]},fetch:function(c){var d=this;c=c?$H.clone(c):{};void 0===c.parse&&(c.parse=!0);var a=c.success;c.success=function(b){if(!d.set(d.parse(b,c),c))return!1;a&&a(d,b,c);d.trigger("sync",d,b,c)};(void 0)(d,c);return d.sync("read",d,c)},save:function(c,d,a){var b,g=this.attributes;
null==c||"object"===typeof c?(b=c,a=d):(b={})[c]=d;a=$H.extend({validate:!0},a);if(b&&!a.wait){if(!this.set(b,a))return!1}else if(!this._validate(b,a))return!1;b&&a.wait&&(this.attributes=$H.extend({},g,b));void 0===a.parse&&(a.parse=!0);var e=this,f=a.success;a.success=function(c){e.attributes=g;var d=e.parse(c,a);a.wait&&(d=$H.extend(b||{},d));if($H.isObject(d)&&!e.set(d,a))return!1;f&&f(e,c,a);e.trigger("sync",e,c,a)};(void 0)(this,a);c=this.isNew()?"create":a.patch?"patch":"update";"patch"===
c&&(a.oAttrs=b);c=this.sync(c,this,a);b&&a.wait&&(this.attributes=g);return c},destroy:function(c){c=c?$H.clone(c):{};var d=this,a=c.success,b=function(){d.trigger("destroy",d,d.collection,c)};c.success=function(e){(c.wait||d.isNew())&&b();a&&a(d,e,c);d.isNew()||d.trigger("sync",d,e,c)};if(this.isNew())return c.success(),!1;(void 0)(this,c);var e=this.sync("delete",this,c);c.wait||b();return e},url:function(){var c=$H.Util.result(this,"urlRoot")||$H.Util.result(this.collection,"url");c||$D.error(Error("\u5fc5\u987b\u8bbe\u7f6e\u4e00\u4e2aurl\u5c5e\u6027\u6216\u8005\u51fd\u6570"));
return this.isNew()?c:c.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(c){return c},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(c){return this._validate({},$H.extend(c||{},{validate:!0}))}})});
$Define("CM.Collection",["CM.AbstractDao","CM.AbstractEvents","CM.Model"],function(h,e,c){var d=e.extend({_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(a,b){if(a instanceof c)return a;b=b?$H.clone(b):{};b.collection=this;var d=new this.model(a,b);if(!d.validationError)return d;this.trigger("invalid",this,d.validationError,b);return!1},_addReference:function(a){this._byId[a.cid]=a;null!=a.id&&(this._byId[a.id]=a);a.collection||(a.collection=this);a.on("all",this._onModelEvent,
this)},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"===a||"remove"===a)&&c!==this||("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))},initialize:function(a,b){this.dao=this.dao||$H.getSingleton(h);b||(b={});b.model&&(this.model=b.model);void 0!==b.comparator&&(this.comparator=
b.comparator);this._reset();a&&this.reset(a,$H.extend({silent:!0},b))},toJSON:function(a){return $H.Collection.map(this,function(b){return b.toJSON(a)})},sync:function(a,b,c){return this.dao.sync({method:a,param:c})},add:function(a,b){$H.extend(b,{add:!0,remove:!1,merge:!1});return this.set(a,b)},remove:function(a,b){var c=!$H.isArray(a);a=c?[a]:$H.clone(a);b||(b={});var d,e,k,l;d=0;for(e=a.length;d<e;d++)if(l=a[d]=this.get(a[d]))delete this._byId[l.id],delete this._byId[l.cid],k=this.indexOf(l),
this.models.splice(k,1),this.length--,b.silent||(b.index=k,l.trigger("remove",l,this,b)),this._removeReference(l,b);return c?a[0]:a},set:function(a,b){b=$H.Util.extend(b,{add:!0,remove:!0,merge:!0});b.parse&&(a=this.parse(a,b));var d=!$H.isArray(a),e=d?a?[a]:[]:$H.clone(a),f,k,l,j,h,q,m=b.at,x=this.model,t=this.comparator&&null==m&&!1!==b.sort,y="string"==typeof this.comparator?this.comparator:null,n=[],u=[],s={},w=b.add,z=b.merge,v=b.remove,p=!t&&w&&v?[]:!1;f=0;for(k=e.length;f<k;f++){h=e[f]||{};
l=h instanceof c?j=h:h[x.prototype.idAttribute||"id"];if(l=this.get(l))v&&(s[l.cid]=!0),z&&(h=h===j?j.attributes:h,b.parse&&(h=l.parse(h,b)),l.set(h,b),t&&(!q&&l.hasChanged(y))&&(q=!0)),e[f]=l;else if(w){j=e[f]=this._prepareModel(h,b);if(!j)continue;n.push(j);this._addReference(j,b)}j=l||j;p&&(j.isNew()||!s[j.id])&&p.push(j);s[j.id]=!0}if(v){f=0;for(k=this.length;f<k;++f)s[(j=this.models[f]).cid]||u.push(j);u.length&&this.remove(u,b)}if(n.length||p&&p.length)if(t&&(q=!0),this.length+=n.length,null!=
m){f=0;for(k=n.length;f<k;f++)this.models.splice(m+f,0,n[f])}else{p&&(this.models.length=0);h=p||n;f=0;for(k=h.length;f<k;f++)this.models.push(h[f])}q&&this.sort({silent:!0});if(!b.silent){f=0;for(k=n.length;f<k;f++)(j=n[f]).trigger("add",j,this,b);(q||p&&p.length)&&this.trigger("sort",this,b)}return d?e[0]:e},reset:function(a,b){b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c],b);b.previousModels=this.models;this._reset();a=this.add(a,$H.extend({silent:!0},
b));b.silent||this.trigger("reset",this,b);return a},push:function(a,b){return this.add(a,$H.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){return this.add(a,$H.extend({at:0},b))},shift:function(a){var b=this.at(0);this.remove(b,a);return b},slice:function(){return Array.prototype.slice.apply(this.models,arguments)},get:function(a){return null==a?void 0:this._byId[a]||this._byId[a.id]||this._byId[a.cid]},at:function(a){return this.models[a]},
where:function(a,b){return $H.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){this.comparator||$D.error(Error("\u6ca1\u6709\u6bd4\u8f83\u5668"));a||(a={});"string"==typeof this.comparator||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort($H.Function.bind(this.comparator,this));a.silent||this.trigger("sort",this,a);return this},pluck:function(a){return $H.Collection.invoke(this.models,
"get",a)},fetch:function(a){var b=this;a=a?$H.clone(a):{};a.url||(a.url=b.url);void 0===a.parse&&(a.parse=!0);var c=a.success;a.success=function(d){b[a.reset?"reset":"set"](d,a);c&&c(b,d,a);b.trigger("sync",b,d,a)};return b.sync("get",b,a)},create:function(a,b){var c=this;b=b?$H.clone(b):{};if(!(a=c._prepareModel(a,b)))return!1;b.wait||c.add(a,b);var d=b.success;b.success=function(a,e){b.wait&&c.add(a,b);d&&d(a,e,b)};a.save(null,b);return a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)}});
$H.each(["some","every","find","filter","invoke"],function(a){d.prototype[a]=function(){var b=Array.prototype.slice.call(arguments),c=$H.Collection;b.unshift(this.models);return c[a].apply(c,b)}});return d});
