/* Handy v1.0.0-dev | 2014-05-09 | zhengyinhui100@gmail.com */
$Define("CM.AbstractEvents",function(){var g=$H.createClass();$H.extend(g.prototype,$H.Events);$H.extend(g.prototype,{_eventCache:{},_listenTo:[],_parseListenToEvents:function(f,a,c,d){var e=this,b=$H.toArray(arguments,3);return e._parseEvents(c,function(h){h.unshift(a);e[f].apply(e,h.concat(b))})},listenTo:function(f,a,c,d,e){if(!this._parseListenToEvents("listenTo",f,a,c,d,e)){"number"==typeof d&&(e=d,d=null);d=d||this;var b=this._delegateHandler(c,d);this._listenTo.push({target:f,name:a,delegation:b,
handler:c});f.on(a,b,d,e)}},unlistenTo:function(f,a,c){if(!this._parseListenToEvents("unlistenTo",f,a,c)){var d=this._listenTo,e="all"==f;$H.each(d,function(b,h){if(e||h.name==a&&h.handler==c&&h.target==f)h.target.off(h.name,h.delegation),d.splice(b,1)})}}});return g});
$Define("CM.DataStore",function(){var g=$H.createClass();$H.extend(g.prototype,{get:function(a,c){var d;if(d=f[a])return c?$H.where(d,c):d},push:function(a,c){"string"!=typeof a&&(c=a,a=null);var d=c.constructor.$ns;(f[d]||(f[d]=[])).push(c);a&&(f[a]||(f[a]=c))}});var f={};$S=$H.getSingleton(g);return g});
$Define("CM.AbstractDao","B.LocalStorage",function(g){var f=$H.createClass();$H.extend(f.prototype,{_ajaxMethodMap:{create:"POST",update:"POST",patch:"PATCH","delete":"DELETE",read:"GET"},_localMethodMap:{create:"setItem",update:"setItem",patch:"setItem","delete":"removeItem",read:"getItem"},ajax:function(a){a=this.parseParam(a);var c=$H.intercept(a.error,this.error);a.error=$H.intercept(c,a.beforeErr);c=$H.intercept(a.success,this.success);a.success=$H.intercept(c,a.beforeSucc);a.beforeSend=$H.intercept($H.bind(this.beforeSend,
this),a.beforeSend);a.complete=$H.intercept($H.bind(this.complete,this),a.complete);return $.ajax(a)},parseParam:$H.noop,beforeSend:function(){this.showLoading(!0)},complete:function(){this.showLoading(!1)},error:$H.noop,success:$H.noop,showLoading:$H.noop,get:function(){},set:function(){},remove:function(){},sync:function(a,c,d){d=d||{};var e=d.storeType||"remote",b={type:"POST",dataType:"json"};d.url||(b.url=c.getUrl());if(null==d.data&&c&&("create"===a||"update"===a||"patch"===a))b.data=d.attrs||
c.toJSON(d);if("remote"==e)b.url+="/"+a+".do",$H.extend(b,d),this.ajax(b);else g[this._localMethodMap[a]](b);c.trigger("request",c,d)}});return f});
$Define("CM.AbstractManager",function(){var g=$H.createClass();$H.extend(g.prototype,{_types:{},_all:{},type:"manager",registerType:function(f,a){this._types[f]=a;a.prototype.xtype=f},getClass:function(f){return $H.isClass(f)?f:this._types[f]||$H.ns(f)},register:function(f){this._all[f.getId()]=f},unregister:function(f){var a=this._all,c=f.getId();a[c]==f&&delete a[c]},eachInEl:function(f,a){var c=this;f.find(".js-"+c.type).each(function(d,e){e=$(e);var b=e.attr("id");(b=c.get(b))&&a(b)})},generateId:function(f,
a){var c=$H.expando+"_"+this.type+"_"+(f||$H.Util.getUuid());if(!0!=a&&this._all[c])$D.error("id\u91cd\u590d:"+c);else return c},get:function(f){var a=this._all;return a[f]||a[this.generateId(f,!0)]}});return g});
$Define("CM.ViewManager","CM.AbstractManager",function(g){var f=$H.createClass();$H.inherit(f,g,{type:"view",initialize:function(){var a=this;$H.on("afterRender",function(c,d){a.afterRender(d)});$H.on("removeEl",function(c,d){a.destroy(d)})},afterRender:function(a){this.eachInEl(a,function(a){a.afterRender()})},destroy:function(a){this.eachInEl(a,function(a){a.destroy(!0)})}});$V=$H.getSingleton(f);return f});
$Define("CM.View",["CM.ViewManager","CM.AbstractEvents","B.Template"],function(g,f){var a=/^(<[a-zA-Z]+)/,c=/^[^>]+class=/,d=/(class=")/,e=f.derive({xtype:"View",_placeholder:'<script id="" type="text/x-placeholder">\x3c/script>',autoRender:!0,renderBy:"append",listeners:[],items:[],tmpl:'<div><%=this.findHtml(">*")%></div>',children:[],_customEvents:"beforeRender render afterRender beforeShow show afterShow beforeHide hide afterHide beforeUpdate update afterUpdate beforeDestroy destroy afterDestroy add remove".split(" "),
_defaultEvents:"mousedown mouseup mouseover mousemove mouseenter mouseleave dragstart drag dragenter dragleave dragover drop dragend touchstart touchmove touchend touchcancel keydown keyup keypress click dblclick focus focusin focusout contextmenu change submit".split(" "),_applyArray:function(b,h){var e=this,a=arguments,c=a.callee.caller,d=c.$owner.prototype;0==a.length?(a=c.arguments,a=$H.toArray(a),b=c.$name,h=a.shift()):a=$H.toArray(a,2);return $H.isArr(h)?($H.each(h,function(h,c){d[b].apply(e,
[c].concat(a))}),!0):!1},_parseListenEvents:function(b,h){var e=this;return e._parseEvents(h.name,function(a){h.name=a[0];2==a.length&&(h.handler=a[1]);e[b].call(e,h)})},initialize:function(b){if(!this.inited){this.manager=this.constructor.manager||$H.getSingleton(g);var h=this.tmpl;$H.isFunc(h)||(this.tmpl=this.constructor.prototype.tmpl=$H.tmpl(h));this.doConfig(b);this.init&&this.init(b);this.parseItems();!1!=this.autoRender&&this.render();this.manager.register(this);this.inited=!0}},doConfig:function(b){var h=
this;h.initParam=b;"string"==typeof b&&(b={text:b});var e=b||{};$H.extend(h,e,{notCover:function(b,a){var c=$H.contains(h._customEvents,b);if($H.contains(h._defaultEvents,b))return h.listeners.push({name:b,handler:e[b]}),!0;if(c)return h.on(b,e[b]),!0;if("defItem"==b)return h[b]=$H.extend(h[b],a),!0;if("listener"==b)return h.listeners=h.listeners.concat($H.isArr(a)?a:[a]),!0;if("items"==b)return h.add(a),!0;if("extCls"==b&&h[b])return h[b]+=" "+a,!0;if("xtype"==b)return"View"==h[b]&&(h[b]="string"==
typeof a?a:a.$ns),!0}});if(b=e.renderTo){if($H.isFunc(b))b=b.call(h);else if($H.isStr(b)&&0==b.indexOf(">")){var a=h.parent;b=a.inited&&a.findEl(b.substring(1))}else b=$(b);h.renderTo=b}else h.renderTo=$(document.body)},getEl:function(){return this._container},getId:function(){return this._id||(this._id=this.manager.generateId(this.cid))},initHtml:function(){return this.tmpl(this)},getHtml:function(){var b=this.getId(),e;e="visibility"==this.displayMode?"visibility:hidden;":"display:none;";var n=
this.initHtml(),p=c.test(n),m="js-"+this.manager.type+" js-"+this.xtype+" "+this.extCls+" ";p&&(n=n.replace(d,"$1"+m));return n=n.replace(a,'$1 id="'+b+'" style="'+e+'"'+(p?"":' class="'+m+'"'))},findHtml:function(b){b=this.find(b);for(var e=[],a=0;a<b.length;a++)e.push(b[a].getHtml());return e.join("")},initStyle:function(){var b=this.getEl(),e=this.style||{};void 0!=this.width&&(e.width=this.width);void 0!=this.height&&(e.height=this.height);b.css(e)},beforeRender:function(){return this.trigger("beforeRender")},
render:function(){if(!1==this.beforeRender())return!1;var b=this.getHtml();this.renderTo[this.renderBy](b);this.afterRender()},afterRender:function(){if(this.rendered)return!1;this.trigger("render");this.callChild();this._container=$("#"+this.getId());this.rendered=!0;this.initStyle();!0!=this.notListen&&this.initListeners();this.disabled&&this.disable();this.trigger("afterRender");this.hidden||this.show()},beforeShow:function(){return this.trigger("beforeShow")},show:function(b,a){var c=this;if(!1==
c.beforeShow()||c.showed||a&&c.hidden)return!1;if(!b&&c.delayShow)setTimeout(function(){e.prototype.show.call(c,!0)},0);else{c.trigger("show");c.showed=!0;var p=c.getEl();"visibility"==c.displayMode?p.css({visibility:"visible"}):p.show();c.callChild([null,!0]);c.afterShow()}},afterShow:function(){var b=this;setTimeout(function(){b.trigger("afterShow")},0)},beforeHide:function(){return this.trigger("beforeHide")},hide:function(){if(!1==this.beforeHide()||!this.showed)return!1;this.showed=!1;var b=
this.getEl();"visibility"==this.displayMode?b.css({visibility:"hidden"}):b.hide();this.trigger("hide");this.afterHide()},afterHide:function(){this.trigger("afterHide")},enable:function(){this.resume();this.getEl().removeClass("hui-disable").find("input,textarea,select").removeAttr("disabled")},disable:function(){this.suspend();this.getEl().addClass("hui-disable").find("input,textarea,select").attr("disabled","disabled")},getContent:function(b,a){a?!a instanceof e&&(a=this.find(a)[0]):a=this;return!1==
b?a.children:a.getEl().html()},setContent:function(b,a){if(a)return!a instanceof e&&(a=this.find(a)[0]),a.setContent(b);var c=this.getEl();c.contents().remove();if("string"==typeof b)c.html(b);else return this.add(b)},listen:function(b){if(!this._parseListenEvents("listen",b)){var a=b.name,e=b.context,c=b.times,d=b.target,j=b.custom||d||$H.contains(this._customEvents,a),f=b.handler;$H.isFunc(d)&&(d=d.call(this));if(j)b=$H.removeUndefined([d,a,f,e,c]),this[d?"listenTo":"on"].apply(this,b);else if(this.listened){var d=
this._listeners,c=b.el,j=b.method||"bind",l=b.selector,g=b.data,e=b.delegation=this._delegateHandler(f,e);$H.isFunc(c)&&(c=c.call(this));c=c?"string"==typeof c?this.findEl(c):c:this.getEl();if(l)if(g)c[j](l,a,g,e);else c[j](l,a,e);else if(g)c[j](a,g,e);else c[j](a,e);d.push(b)}else this.listeners.push(b)}},unlisten:function(b){if(!this._parseListenEvents("unlisten",b)){var a=b.name,e=b.handler;if(b.custom)this.off(a,e);else{var c=b.el,d="delegate"==b.method?"undelegate":"unbind";b=b.selector;for(var f,
c=c?"string"==typeof c?this.findEl(c):c:this.getEl(),k=this._listeners.length-1;0<=k;k--){var g=this._listeners[k];if(g.handler==e){f=g.delegation;this._listeners.splice(k,1);break}}if(b)c[d](b,a,f);else c[d](a,f)}}},initListeners:function(){if(this.listened)return!1;this.listened=!0;var b=this.listeners;this._listeners=[];for(var a=b.length-1;0<=a;a--)this.listen(b[a]);this.callChild()},clearListeners:function(){for(var b=this._listeners,a=b.length-1;0<=a;a--)this.unlisten(b[a]);this.off("all");
this.unlistenTo("all");this.callChild()},suspend:function(){if(this.isSuspend)return!1;this.isSuspend=!0;this.callChild()},resume:function(){if(!this.isSuspend)return!1;this.isSuspend=!1;this.callChild()},findEl:function(b){return this.getEl().find(b)},parentsEl:function(b){return this.getEl().parents(b)},each:function(b,a){for(var e=this.children,c=e.length,d,f=0;f<c;){d=e[f];d=a?b.apply(d,a):b(f,d);if(!1===d)break;c==e.length?f++:c=e.length}},match:function(b,a){if("*"==b)return!0;var e=a||this,
c,d,f;b=b.replace(/#([^\s,\[]+)/,"[cid=$1]");b=b.replace(/^([^\[]+)/,"[xtype=$1]");for(var g=/\[([^=|\!]+)(=|\!=)([^=]+)\]/g;c=g.exec(b);){d=c[1];f=c[2];c=c[3];if("false"==c||"true"==c)c=eval(c);if("="===f?e[d]!=c:e[d]==c)return!1}return!0},find:function(b,a){var e=this;a=a||[];if($H.isNum(b))a.push(e.children[b]);else if($H.isStr(b)){if(0<b.indexOf(","))return $H.each(b.split(","),function(b,c){a=a.concat(e.find(c))}),a;var c=0==b.indexOf(">"),d=b.replace(/^>?\s?/,""),f=d.search(/\s|>/),g;0<f&&(g=
d.substring(f),d=d.substring(0,f));e.each(function(e,n){n.match(d)&&(g?n.find(g,a):a.push(n));c||n.find(b,a)})}else if($H.isFunc(b)){var l=$H.isClass(b);e.each(function(e,c){(l&&c instanceof b||!l&&b(c))&&a.push(c);c.find(b,a)})}return a},parents:function(b){for(var a=this;a.parent;)if(a=a.parent,b&&this.match(b,a))return a;return b||a===this?null:a},index:function(){var b=this,a=b.parent;if(a){var e;a.each(function(a,c){if(c==b)return e=a,!1});return e}return null},callChild:function(b,a){0!=this.children.length&&
(b&&"string"!=typeof b&&(a=b,b=null),b=b||arguments.callee.caller.$name,this.each(function(e,c){a?c[b].apply(c,a):c[b].call(c)}))},add:function(b,a){if(!this._applyArray()){var c=void 0==a;if(this.startParseItems){if(b instanceof e)b.parent=this;else{this.defItem&&$H.extend(b,this.defItem,{notCover:!0});this.parseItem(b);var d=this.manager.getClass(b.xtype);if(d){var f=b.renderTo;!this.inited&&($H.isStr(f)&&0==f.indexOf(">"))&&(f=null);f||(this.inited?b.renderTo=this.getEl():b.autoRender=!1);b.parent=
this;b=new d(b)}else $D.error("xtype:"+b.xtype+"\u672a\u627e\u5230")}d=this.children;c?d.push(b):d.splice(a,0,b);this.trigger("add",b);return b}d=this.items;c?d.push(b):d.splice(a,0,b)}},remove:function(b){if(!this._applyArray()){var a=this.children,c=!1,d;if($H.isNum(b))d=b,b=a[d];else if($H.isStr(b)||$H.isFunc(b)){b=this.find(b);for(var f=0,g=b.length;f<g;f++){if(!1==this.remove(b[f]))return!1;c=!0}}else if(b instanceof e)if(b.parent==this){f=0;for(g=a.length;f<g;f++)if(a[f]==b){d=f;break}}else return b.parent.remove(b);
void 0!=d&&!1!=b.destroy(!0)&&(a.splice(d,1),c=!0);this.trigger("remove",b);return c}},parseItem:function(){},parseItems:function(){this.startParseItems=!0;var b=this.items;if(b)for(var b=$H.isArr(b)?b:[b],a=0,e=b.length;a<e;a++)this.add(b[a])},beforeUpdate:function(){return this.trigger("beforeUpdate")},update:function(b,a){if(!1==this.beforeUpdate())return!1;b=b||{};var e=this.parent,c=$("<span></span>").insertBefore(this.getEl());a||(void 0==b.autoRender&&(b.autoRender=!0),b=$H.extend(b,this.initParam,
{notCover:!0}));b=$H.extend(b,{xtype:this.xtype,renderBy:"replaceWith",renderTo:c},{notCover:["xtype"]});if(!b.cid||b.cid==this.cid)b._id=this._id;if(e){var d=this.index();if(!1==e.remove(this))return c.remove(),!1;e=e.add(b,d)}else{if(!1==this.destroy())return c.remove(),!1;e=new this.constructor(b)}this.trigger("update",e);this.afterUpdate(e);return e},replace:function(b){return this.update(b,!0)},afterUpdate:function(b){this.trigger("afterUpdate",b)},beforeDestroy:function(){return this.trigger("beforeDestroy")},
destroy:function(b){if(!1==this.beforeDestroy())return!1;if(!this.destroyed)return this.callChild(),this.trigger("destroy"),this.clearListeners(),this.getEl().remove(),this.destroyed=!0,!b&&this.parent&&this.parent.remove(this),this.manager.unregister(this),delete this.initParam,delete this._container,delete this.renderTo,delete this._listeners,delete this.children,this.afterDestroy(),!0},afterDestroy:function(){this.trigger("afterDestroy")}},{extend:function(b){var a=this.prototype;$H.extend(a,b,
{notCover:function(e){if($H.contains(["_customEvents","listeners"],e))return a[e]=(b[e]||[]).concat(a[e]||[]),!0;if("xtype"==e||"constructor"==e)return!0}})},html:function(b){return(new this($H.extend({autoRender:!1},b))).getHtml()}});return e});
$Define("CM.Model",["CM.AbstractDao","CM.AbstractEvents","CM.DataStore"],function(g,f){return f.derive({idAttribute:"id",_pending:!1,_validate:function(a,c){if(!c.validate||!this.validate)return!0;a=$H.extend({},this._attributes,a);var d=this.validationError=this.validate(a,c)||null;if(!d)return!0;this.trigger("invalid",this,d,$H.extend(c,{validationError:d}));return!1},_initDepFields:function(){var a=this.fields,c,d;for(d in a)if(c=a[d],c=c.depends)for(var e=0;e<c.length;e++)this.on("change:"+c[e],
$H.bind(this.set,this,d,null,null))},_parseFields:function(a){var c;if(!(c=this.fields))return a;var d,e,b,h={},f;for(f in a){e=a[f];if(d=c[f]){b=$H.isObj(d)?d.type:d;if(d=d.parse)e=d.apply(this,[e,a]);$H.isStr(b)&&("Date"==b?e=$H.parseDate(e):0<b.indexOf(".")&&(b=$H.ns(b)));$H.isClass(b)&&!(e instanceof b)&&(e=new b(e),e.on("all",$H.bind(this._onAttrEvent,this,f)))}h[f]=e}return h},_onAttrEvent:function(a,c){if(!("invalid"==c||"sync"==c)){var d=this.get(a);0!=c.indexOf("change:")&&(this.trigger("change:"+
a,this,d),this.trigger("change",this))}},initialize:function(a,c){this.dao=this.dao||$H.getSingleton(g);this._initDepFields();var d=a||{};c||(c={});this.cid=$H.Util.getUuid();this._attributes={};c.collection&&(this.collection=c.collection);c.parse&&(d=this.parse(d,c)||{});d=$H.extend(d,$H.Util.result(this,"defaults"),{notCover:!0});this.set(d,c);this._changed={};$S.push(this)},toJSON:function(){return $H.clone(this._attributes)},sync:function(a,c,d){return this.dao.sync(a,c,d)},get:function(a){return this._attributes[a]},
escape:function(a){return $H.String.escapeHTML(this.get(a))},has:function(a){a=this.get(a);return null!=a&&void 0!=a},set:function(a,c,d){var e;"object"===typeof a?(e=a,d=c):(e={})[a]=c;d||(d={});e=this._parseFields(e);if(!this._validate(e,d))return!1;var b=d.unset;a=d.silent;var h=[],f=this._changing;this._changing=!0;f||(this._previousAttributes=$H.Object.clone(this._attributes),this._changed={});var p=this._attributes,g=this._previousAttributes;this.idAttribute in e&&(this.id=e[this.idAttribute]);
for(var j in e)c=e[j],$H.equals(p[j],c)||h.push(j),$H.equals(g[j],c)?delete this._changed[j]:this._changed[j]=c,b?delete p[j]:p[j]=c;if(!a){h.length&&(this._pending=d);c=0;for(e=h.length;c<e;c++)this.trigger("change:"+h[c],this,p[h[c]],d)}if(f)return this;if(!a)for(;this._pending;)d=this._pending,this._pending=!1,this.trigger("change",this,d);this._changing=this._pending=!1;return this},unset:function(a,c){c=c||{};c.unset=!0;return this.set(a,void 0,c)},clear:function(a){var c={},d;for(d in this._attributes)c[d]=
void 0;a=a||{};a.unset=!0;return this.set(c,a)},hasChanged:function(a){var c=this._changed;return null==a?!$H.isEmpty(c):$H.contains(c,a)},changedAttrbutes:function(a){if(!a)return this.hasChanged()?$H.clone(this._changed):!1;var c,d=!1,e=this._changing?this._previousAttributes:this._attributes,b;for(b in a)if(!$H.equals(e[b],c=a[b]))(d||(d={}))[b]=c;return d},previous:function(a){return null==a||!this._previousAttributes?null:this._previousAttributes[a]},fetch:function(a){var c=this;a=a?$H.clone(a):
{};void 0===a.parse&&(a.parse=!0);var d=a.success,e=a.beforeSet;a.success=function(b){if(!(e&&!1==e(c,b,a))){if(!c.set(c.parse(b,a),a))return!1;d&&d(c,b,a);c.trigger("sync",c,b,a)}};c.sync("read",c,a)},save:function(a,c,d){var e=this,b;null==a||"object"===typeof a?(b=a,d=c):(b={})[a]=c;$H.isFunc(d)&&(d={success:d});d=$H.extend({validate:!0},d);if(b&&d.now){if(!e.set(b,d))return!1}else if(!e._validate(b,d))return!1;void 0===d.parse&&(d.parse=!0);var h=d.success;d.success=function(a){var c=e.parse(a,
d);d.now||(c=$H.extend(b||{},c));if($H.isObj(c)&&!e.set(c,d))return!1;h&&h(e,a,d);e.trigger("sync",e,a,d)};a=e.isNew()?"create":d.update?"update":"patch";if("patch"===a){c=e.changedAttrbutes(b);if(!c){h&&h(e,d);return}d.attrs=c}else c=$H.extend({},e._attributes),d.attrs=$H.extend(c,b);e.sync(a,e,d)},destroy:function(a){var c=this;a=a?$H.clone(a):{};var d=a.success,e=function(){c.trigger("destroy",c,c.collection,a);c.off("all")};a.success=function(b){(!a.now||c.isNew())&&e();d&&d(c,b,a);c.isNew()||
c.trigger("sync",c,b,a)};if(c.isNew())return a.success(),!1;c.sync("delete",c,a);a.now&&e()},getUrl:function(){var a=$H.result(this,"url")||$H.result(this.collection,"url");a||$D.error(Error("\u5fc5\u987b\u8bbe\u7f6e\u4e00\u4e2aurl\u5c5e\u6027\u6216\u8005\u51fd\u6570"));return this.isNew()?a:a.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(a){return a.code&&a.data?a.data:a},clone:function(){return new this.constructor(this._attributes)},isNew:function(){return void 0==this.id},
isValid:function(a){return this._validate({},$H.extend(a||{},{validate:!0}))}})});
$Define("CM.Collection",["CM.AbstractDao","CM.AbstractEvents","CM.Model","CM.DataStore"],function(g,f,a){var c=f.derive({_reset:function(){this.length=0;this._models=[];this._byId={}},_prepareModel:function(e,b){if(e instanceof a)return e;b=b?$H.clone(b):{};b.collection=this;var c=$S.get(this.model.$ns,{id:b.id});if(c=c&&c[0])return c.set(e,b),c;c=new this.model(e,b);if(!c.validationError)return c;this.trigger("invalid",this,c.validationError,b);return!1},_addReference:function(a){this._byId[a.cid]=
a;null!=a.id&&(this._byId[a.id]=a);a.collection||(a.collection=this);a.on("all",this._onModelEvent,this)},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"===a||"remove"===a)&&c!==this||("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))},initialize:function(a,b){this.dao=this.dao||
$H.getSingleton(g);b||(b={});b.model&&(this.model=b.model);b.url&&(this.url=b.url);void 0!==b.comparator&&(this.comparator=b.comparator);this._reset();a&&this.reset(a,$H.extend({silent:!0},b))},toJSON:function(a){return $H.map(this._models,function(b){return b.toJSON(a)})},sync:function(a,b,c){return this.dao.sync(a,b,c)},add:function(a,b){b=$H.extend({add:!0,remove:!1,merge:!1},b);return this.set(a,b)},remove:function(a,b){var c=!$H.isArr(a);a=c?[a]:$H.clone(a);b||(b={});var d,f,g,j;d=0;for(f=a.length;d<
f;d++)if(j=a[d]=this.get(a[d]))delete this._byId[j.id],delete this._byId[j.cid],g=this.indexOf(j),this._models.splice(g,1),this.length--,b.silent||(b.index=g,j.trigger("remove",j,this,b)),this._removeReference(j,b);return c?a[0]:a},set:function(c,b){if(c){b=$H.extend({add:!0,remove:!0,merge:!0},b);b.parse&&(c=this.parse(c,b));var d=!$H.isArr(c),f=d?c?[c]:[]:$H.clone(c),g,m,j,k,l,s,t,v=b.at,A=this.model,w=this.comparator&&null==v&&!1!==b.sort,B="string"==typeof this.comparator?this.comparator:null,
q=[],x=[],u={},z=b.add,C=b.merge,y=b.remove,r=!w&&z&&y?[]:!1;g=0;for(m=f.length;g<m;g++){l=f[g]||{};j=l instanceof a?k=l:l[A.prototype.idAttribute||"id"];if(s=this.get(j))y&&(u[s.cid]=!0),C&&(l=l===k?k.attributes:l,b.parse&&(l=s.parse(l,b)),s.set(l,b),w&&(!t&&s.hasChanged(B))&&(t=!0)),f[g]=s;else if(z){b.id=j;k=f[g]=this._prepareModel(l,b);if(!k)continue;q.push(k);this._addReference(k,b)}k=s||k;r&&(k.isNew()||!u[k.id])&&r.push(k);u[k.id]=!0}if(y){g=0;for(m=this.length;g<m;++g)u[(k=this._models[g]).cid]||
x.push(k);x.length&&this.remove(x,b)}if(q.length||r&&r.length)if(w&&(t=!0),this.length+=q.length,null!=v){g=0;for(m=q.length;g<m;g++)this._models.splice(v+g,0,q[g])}else{r&&(this._models.length=0);j=r||q;g=0;for(m=j.length;g<m;g++)this._models.push(j[g])}t&&this.sort({silent:!0});if(!b.silent){g=0;for(m=q.length;g<m;g++)(k=q[g]).trigger("add",k,this,b);(t||r&&r.length)&&this.trigger("sort",this,b)}return d?f[0]:f}},each:function(a){$H.each(this._models,a)},reset:function(a,b){b||(b={});for(var c=
0,d=this._models.length;c<d;c++)this._removeReference(this._models[c],b);b.previousModels=this._models;this._reset();a&&(a=this.add(a,$H.extend({silent:!0},b)));b.silent||this.trigger("reset",this,b);return a},push:function(a,b){return this.add(a,$H.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){return this.add(a,$H.extend({at:0},b))},shift:function(a){var b=this.at(0);this.remove(b,a);return b},slice:function(){return Array.prototype.slice.apply(this._models,
arguments)},get:function(a){return null==a?void 0:this._byId[a]||this._byId[a.id]||this._byId[a.cid]},size:function(){return this.length},at:function(a){return this._models[a]},where:function(a,b){return $H.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){this.comparator||$D.error(Error("\u6ca1\u6709\u6bd4\u8f83\u5668"));a||(a={});"string"==typeof this.comparator||1===this.comparator.length?
this._models=this.sortBy(this.comparator,this):this._models.sort($H.Function.bind(this.comparator,this));a.silent||this.trigger("sort",this,a);return this},pluck:function(a){return $H.invoke(this._models,"get",a)},getUrl:function(){return this.url},fetch:function(a){var b=this;a=a?$H.clone(a):{};void 0===a.parse&&(a.parse=!0);var c=a.success,d=a.beforeSet;a.success=function(f){d&&!1==d(b,f,a)||(b[a.reset?"reset":a.add?"add":"set"](f,a),c&&c(b,f,a),b.trigger("sync",b,f,a))};return b.sync("read",b,
a)},create:function(a,b){var c=this;b=b?$H.clone(b):{};if(!(a=c._prepareModel(a,b)))return!1;b.now&&c.add(a,b);var d=b.success;b.success=function(a,e){b.now||c.add(a,b);d&&d(a,e,b)};a.save(null,b);return a},parse:function(a){return a.data},clone:function(){return new this.constructor(this._models)}}),d=$H.Array;$H.each("map some every find filter invoke indexOf".split(" "),function(a,b){c.prototype[b]=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this._models);return d[b].apply(d,
a)}});$H.each(["sortBy","groupBy","countBy"],function(a){c.prototype[a]=function(b,c){var f=$H.isFunc(b)?b:function(a){return a.get(b)};return d[a](this._models,f,c)}});return c});
