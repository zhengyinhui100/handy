/* Handy v1.0.0-dev | 2014-03-19 | zhengyinhui100@gmail.com */
$Define("CM.AbstractDao",function(){var h=$H.createClass();$HO.extend(h.prototype,{ajax:function(e){this.beforeSend(e);e.error=$HF.intercept(this.error,e.error);e.success=$HF.intercept(this.success,e.success);return $.ajax(e)},beforeSend:$H.noop,error:$H.noop,success:$H.noop,sync:$H.noop});return h});
$Define("CM.AbstractManager",function(){var h=$H.createClass();$HO.extend(h.prototype,{_types:{},_all:{},type:"manager",registerType:function(e,c){this._types[e]=c;c.prototype.xtype=e},getClass:function(e){return this._types[e]},register:function(e){this._all[e.getId()]=e},unregister:function(e){var c=this._all,d=e.getId();c[d]==e&&delete c[d]},eachInEl:function(e,c){var d=this;e.find(".js-"+d.type).each(function(a,b){b=$(b);var m=b.attr("id");(m=d.get(m))&&c(m)})},generateId:function(e,c){var d=
$H.expando+"_"+this.type+"_"+(e||$H.Util.getUuid());if(!0!=c&&this._all[d])$D.error("id\u91cd\u590d:"+d);else return d},get:function(e){var c=this._all;return c[e]||c[this.generateId(e,!0)]}});return h});
$Define("CM.ViewManager","CM.AbstractManager",function(h){var e=$H.createClass();$H.inherit(e,h,{type:"view",initialize:function(){var c=this;$H.on("afterRender",function(d){c.afterRender(d)});$H.on("removeEl",function(d){c.destroy(d)})},afterRender:function(c){this.eachInEl(c,function(c){c.afterRender()})},destroy:function(c){this.eachInEl(c,function(c){c.destroy(!0)})}});$V=$HO.getSingleton(e);return e});
$Define("CM.View","CM.ViewManager",function(h){var e=$H.createClass(),c=/^(<[a-zA-Z]+)/,d=/^[^>]+class=/,a=/(class=")/;$HO.extend(e,{extend:function(b){var a=this.prototype;$HO.extend(a,b,{notCover:function(f){if($HO.contains(["_customEvents","listeners"],f))return a[f]=(b[f]||[]).concat(a[f]||[]),!0;if("xtype"==f||"constructor"==f)return!0}})},html:function(b){return(new this($HO.extend({autoRender:!1},b))).getHtml()}});$HO.extend(e.prototype,$H.Events);$HO.extend(e.prototype,{xtype:"View",autoRender:!0,
renderBy:"append",children:[],_customEvents:"beforeRender render afterRender beforeShow show afterShow beforeHide hide afterHide beforeUpdate update afterUpdate beforeDestroy destroy afterDestroy".split(" "),_defaultEvents:"mousedown mouseup mouseover mousemove mouseenter mouseleave dragstart drag dragenter dragleave dragover drop dragend touchstart touchmove touchend touchcancel keydown keyup keypress click dblclick focus focusin focusout contextmenu change submit".split(" "),initialize:function(b){this.manager=
this.constructor.manager||$HO.getSingleton(h);this.doConfig(b);this.parseItems();!1!=this.autoRender&&this.render();this.manager.register(this)},doConfig:function(b){var a=this;a.params=b;a.settings=$HO.clone(b);a.renderTo=b.renderTo?$(b.renderTo):$(document.body);var f=a.listeners||[];b.listeners&&(f=f.concat(b.listeners));a._listeners=f;$HO.extend(a,b,{notCover:function(f){var c=a[f],d=$HO.contains(a._customEvents,f);if($HO.contains(a._defaultEvents,f))a._listeners.push({name:f,handler:b[f]});else if(d)a.on(f,
b[f]);if(null!=c&&"object"==typeof c||$HO.isFunction(c))return!0}});b.defItem&&$HO.extend(a.defItem,b.defItem)},getEl:function(){return this._container},getId:function(){return this._id||(this._id=this.manager.generateId(this.cid))},initHtml:function(){"string"!=typeof this.tmpl&&(this.tmpl=this.constructor.prototype.tmpl=this.tmpl.join(""));return $H.Template.tmpl({id:this.xtype,tmpl:this.tmpl},this)},getHtml:function(){var b=this.getId(),m;m="visibility"==this.displayMode?"visibility:hidden;":"display:none;";
var f=this.initHtml(),j=d.test(f),k="js-"+this.manager.type+" "+this.extCls+" ";j&&(f=f.replace(a,"$1"+k));return f=f.replace(c,'$1 id="'+b+'" style="'+m+'"'+(j?"":' class="'+k+'"'))},findHtml:function(b){b=">*"==b?this.children:this.find(b);for(var a=[],f=0;f<b.length;f++)a.push(b[f].getHtml());return a.join("")},initStyle:function(){var b=this.getEl(),a=this.style||{};void 0!=this.width&&(a.width=this.width);void 0!=this.height&&(a.height=this.height);b.css(a)},beforeRender:function(){return this.trigger("beforeRender")},
render:function(){if(!1==this.beforeRender())return!1;this.trigger("render");var b=this.getHtml();this.renderTo[this.renderBy](b);this.afterRender()},afterRender:function(){if(this.rendered)return!1;this.callChild();this._container=$("#"+this.getId());this.rendered=!0;this.initStyle();!0!=this.notListen&&this.initListeners();this.disabled&&this.disable();this.trigger("afterRender");this.hidden||this.show()},beforeShow:function(){return this.trigger("beforeShow")},show:function(b,a){var f=this;if(!1==
f.beforeShow()||f.showed||a&&f.hidden)return!1;if(!b&&f.delayShow)setTimeout(function(){e.prototype.show.call(f,!0)},0);else{f.trigger("show");f.showed=!0;var c=f.getEl();"visibility"==f.displayMode?c.css({visibility:"visible"}):c.show();f.callChild([null,!0]);f.afterShow()}},afterShow:function(){this.trigger("afterShow")},beforeHide:function(){return this.trigger("beforeHide")},hide:function(){if(!1==this.beforeHide()||!this.showed)return!1;this.showed=!1;var b=this.getEl();"visibility"==this.displayMode?
b.css({visibility:"hidden"}):b.hide();this.trigger("hide");this.afterHide()},afterHide:function(){this.trigger("afterHide")},enable:function(){this.resume();this.getEl().removeClass("hui-disable").find("input,textarea,select").removeAttr("disabled")},disable:function(){this.suspend();this.getEl().addClass("hui-disable").find("input,textarea,select").attr("disabled","disabled")},listen:function(b){var a=this,f=b.name,c=b.context,d=b.handler;if(b.custom)a.on(f,d,c);else{var l=a._listeners,g=b.el,e=
b.method||"bind",n=b.selector,h=b.data,r=b.delegation=function(){if(!0!=a.isSuspend)return d.apply(c||a,arguments)};$H.Browser.mobile()&&"click"==f&&(f="touchend");g=g?"string"==typeof g?a.find(g):g:a.getEl();if(n)if(h)g[e](n,f,h,r);else g[e](n,f,r);else if(h)g[e](f,h,r);else g[e](f,r);l.push(b)}},unlisten:function(b){var a=b.name,f=b.handler;if(b.custom)this.off(a,f);else{var c=b.el,d="delegate"==b.method?"undelegate":"unbind";b=b.selector;var e;$H.Browser.mobile()&&"click"==a&&(a="touchend");for(var c=
c?"string"==typeof c?this.find(c):c:this.getEl(),g=this._listeners.length-1;0<=g;g--){var h=this._listeners[g];if(h.handler==f){e=h.delegation;this._listeners.splice(g,1);break}}if(b)c[d](b,a,e);else c[d](a,e)}},initListeners:function(){if(this.listened)return!1;this.listened=!0;var b=this._listeners;this._listeners=[];for(var a=b.length-1;0<=a;a--)this.listen(b[a]);this.callChild()},clearListeners:function(){for(var b=this._listeners,a=b.length-1;0<=a;a--)this.unlisten(b[a]);this.off("all");this.callChild()},
suspend:function(){if(this.isSuspend)return!1;this.isSuspend=!0;this.callChild()},resume:function(){if(!this.isSuspend)return!1;this.isSuspend=!1;this.callChild()},each:function(b,a){for(var c=this.children,d=c.length,k,e=0;e<d;){k=c[e];k=a?b.apply(k,a):b(e,k);if(!1===k)break;d==c.length?e++:d=c.length}},match:function(b,a){if("*"==b)return!0;var c=a||this,d,e,l;b=b.replace(/^([^\[]+)/,'[xtype="$1"]');for(var g=/\[([^=|\!]+)(=|\!=)([^=]+)\]/g;d=g.exec(b);)if(e=d[1],l=d[2],d=eval(d[3]),"="===l?c[e]!=
d:c[e]==d)return!1;return!0},find:function(b,a){var c=this;if(0!=b.indexOf("$"))return c.getEl().find(b);a=a||[];if(0<b.indexOf(","))return $HO.each(b.split(","),function(b,d){a=a.concat(c.find(d))}),a;var d=1==b.indexOf(">"),e=b.replace(/^\$>?\s?/,""),l=e.search(/\s|>/),g;0<l&&(g=e.substring(l),e=e.substring(0,l));c.each(function(c,f){f.match(e)&&(g?f.find("$"+g,a):a.push(f));d||f.find(b,a)});return a},parents:function(b){if(b&&0!=b.indexOf("$"))return this.getEl().parents(b);for(var a=this;a.parent;)if(a=
a.parent,b&&this.match(b,a))return a;return b||a===this?null:a},index:function(){var b=this,a=b.parent;if(a){var c;a.each(function(a,d){if(d==b)return c=a,!1});return c}return null},callChild:function(b,a){0!=this.children.length&&(b&&"string"!=typeof b&&(a=b,b=null),b=b||arguments.callee.caller.$name,this.each(function(c,d){a?d[b].apply(d,a):d[b].call(d)}))},add:function(b){this.children.push(b);b.parent=this},remove:function(b){for(var a=this.children,c=!1,d=0,e=a.length;d<e;d++)a[d]==b&&(a.splice(d,
1),b.destroy(),c=!0);return c},addItem:function(b){var a=this.settings,c=a.items;c?$HO.isArray(c)||(a.items=[c]):a.items=[];a.items.push(b)},parseItem:function(){},parseItems:function(){var b=this.settings.items;if(b)for(var b=b.length?b:[b],a=0,c=b.length;a<c;a++){var d=b[a];this.defItem&&$HO.extend(d,this.defItem,{notCover:!0});this.parseItem(d);var e=this.manager.getClass(d.xtype);e?(d.renderTo||(d.autoRender=!1),d=new e(d),this.add(d)):$D.error("xtype:"+d.xtype+"\u672a\u627e\u5230")}},beforeUpdate:function(){return this.trigger("beforeUpdate")},
update:function(b){var a=this;if(!1==a.beforeUpdate())return!1;var c=a.parent;b=$HO.extend({renderBy:"before",renderTo:a.getEl()},b);c&&(b=$HO.extend(c.defItem,b),c.parseItem(b));if(!b.cid||b.cid==a.cid)b._id=a._id;var d=new a.constructor(b);c&&(d.parent=c,c.each(function(b,e){if(e==a)return c.children.splice(b,1,d),!1}));a.destroy();a.trigger("update");a.afterUpdate(d);return d},afterUpdate:function(a){this.trigger("afterUpdate",a)},beforeDestroy:function(){return this.trigger("beforeDestroy")},
destroy:function(){if(!1==this.beforeDestroy()||this.destroyed)return!1;this.callChild();this.trigger("destroy");this.clearListeners();this.getEl().remove();this.destroyed=!0;this.parent&&this.parent.remove(this);this.manager.unregister(this);delete this.params;delete this.settings;delete this._container;delete this.renderTo;delete this._listeners;delete this.children;this.afterDestroy()},afterDestroy:function(){this.trigger("afterDestroy")}});return e});
$Define("CM.Model",function(){var h=$H.createClass();$HO.extend(h.prototype,$H.Events);$HO.extend(h.prototype,{_pending:!1,idAttribute:"id",_validate:function(c,d){if(!d.validate||!this.validate)return!0;c=$HO.extend({},this.attributes,c);var a=this.validationError=this.validate(c,d)||null;if(!a)return!0;this.trigger("invalid",this,a,$HO.extend(d,{validationError:a}));return!1},initialize:function(c,d){var a=c||{};d||(d={});this.cid=$H.Util.getUuid();this.attributes={};d.collection&&(this.collection=
d.collection);d.parse&&(a=this.parse(a,d)||{});a=$HO.extend(a,$H.Util.result(this,"defaults"),{notCover:!0});this.set(a,d);this.changed={}},toJson:function(){return $HO.clone(this.attributes)},sync:function(c,d,a){return this.dao.sync.apply(this,arguments)},get:function(c){return this.attributes[c]},escape:function(c){return $H.String.escapeHTML(this.get(c))},has:function(c){c=this.get(c);return null!=c&&void 0!=c},set:function(c,d,a){var b;"object"===typeof c?(b=c,a=d):(b={})[c]=d;a||(a={});if(!this._validate(b,
a))return!1;var e=a.unset;c=a.silent;var f=[],j=this._changing;this._changing=!0;j||(this._previousAttributes=$H.Object.clone(this.attributes),this.changed={});var k=this.attributes,l=this._previousAttributes;this.idAttribute in b&&(this.id=b[this.idAttribute]);for(var g in b)d=b[g],$HO.equals(k[g],d)||f.push(g),$HO.equals(l[g],d)?delete this.changed[g]:this.changed[g]=d,e?delete k[g]:k[g]=d;if(!c){f.length&&(this._pending=a);d=0;for(b=f.length;d<b;d++)this.trigger("change:"+f[d],this,k[f[d]],a)}if(j)return this;
if(!c)for(;this._pending;)a=this._pending,this._pending=!1,this.trigger("change",this,a);this._changing=this._pending=!1;return this},unset:function(c,d){d=d||{};d.unset=!0;return this.set(c,void 0,d)},clear:function(c){var d={},a;for(a in this.attributes)d[a]=void 0;c=c||{};c.unset=!0;return this.set(d,c)},hasChanged:function(c){var d=this.changed;return null==c?!$HO.isEmpty(d):$HO.contains(d,c)},changedAttrbutes:function(c){if(!c)return this.hasChanged()?$HO.clone(this.changed):!1;var d,a=!1,b=
this._changing?this._previousAttributes:this.attributes,e;for(e in c)if(!$HO.equals(b[e],d=c[e]))(a||(a={}))[e]=d;return a},previous:function(c){return null==c||!this._previousAttributes?null:this._previousAttributes[c]},fetch:function(c){var d=this;c=c?$HO.clone(c):{};void 0===c.parse&&(c.parse=!0);var a=c.success;c.success=function(b){if(!d.set(d.parse(b,c),c))return!1;a&&a(d,b,c);d.trigger("sync",d,b,c)};e(d,c);return d.sync("read",d,c)},save:function(c,d,a){var b,m=this.attributes;null==c||"object"===
typeof c?(b=c,a=d):(b={})[c]=d;a=$HO.extend({validate:!0},a);if(b&&!a.wait){if(!this.set(b,a))return!1}else if(!this._validate(b,a))return!1;b&&a.wait&&(this.attributes=$HO.extend({},m,b));void 0===a.parse&&(a.parse=!0);var f=this,j=a.success;a.success=function(c){f.attributes=m;var d=f.parse(c,a);a.wait&&(d=$HO.extend(b||{},d));if($HO.isObject(d)&&!f.set(d,a))return!1;j&&j(f,c,a);f.trigger("sync",f,c,a)};e(this,a);c=this.isNew()?"create":a.patch?"patch":"update";"patch"===c&&(a.oAttrs=b);c=this.sync(c,
this,a);b&&a.wait&&(this.attributes=m);return c},destroy:function(c){c=c?$HO.clone(c):{};var d=this,a=c.success,b=function(){d.trigger("destroy",d,d.collection,c)};c.success=function(f){(c.wait||d.isNew())&&b();a&&a(d,f,c);d.isNew()||d.trigger("sync",d,f,c)};if(this.isNew())return c.success(),!1;e(this,c);var m=this.sync("delete",this,c);c.wait||b();return m},url:function(){var c=$H.Util.result(this,"urlRoot")||$H.Util.result(this.collection,"url");c||$D.error(Error("\u5fc5\u987b\u8bbe\u7f6e\u4e00\u4e2aurl\u5c5e\u6027\u6216\u8005\u51fd\u6570"));
return this.isNew()?c:c.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(c){return c},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(c){return this._validate({},$HO.extend(c||{},{validate:!0}))}});var e;return h});
$Define("CM.Collection",["CM.AbstractDao","CM.Model"],function(h,e){var c=$H.createClass();$HO.extend(c.prototype,$H.Events);$HO.extend(c.prototype,{dao:$H.getSingleton(h),_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(a,b){if(a instanceof e)return a;b=b?$HO.clone(b):{};b.collection=this;var c=new this.model(a,b);if(!c.validationError)return c;this.trigger("invalid",this,c.validationError,b);return!1},_addReference:function(a){this._byId[a.cid]=a;null!=a.id&&
(this._byId[a.id]=a);a.collection||(a.collection=this);a.on("all",this._onModelEvent,this)},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"===a||"remove"===a)&&c!==this||("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))},initialize:function(a,b){b||(b={});b.model&&(this.model=
b.model);void 0!==b.comparator&&(this.comparator=b.comparator);this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,$HO.extend({silent:!0},b))},toJSON:function(a){return $H.Collection.map(this,function(b){return b.toJSON(a)})},sync:function(a,b,c){return this.dao.sync.apply(this,arguments)},add:function(a,b){$HO.extend(b,{add:!0,remove:!1,merge:!1});return this.set(a,b)},remove:function(a,b){var c=!$HO.isArray(a);a=c?[a]:$HO.clone(a);b||(b={});var d,e,k,l;d=0;for(e=a.length;d<e;d++)if(l=
a[d]=this.get(a[d]))delete this._byId[l.id],delete this._byId[l.cid],k=this.indexOf(l),this.models.splice(k,1),this.length--,b.silent||(b.index=k,l.trigger("remove",l,this,b)),this._removeReference(l,b);return c?a[0]:a},set:function(a,b){b=$H.Util.extend(b,{add:!0,remove:!0,merge:!0});b.parse&&(a=this.parse(a,b));var c=!$HO.isArray(a),d=c?a?[a]:[]:$HO.clone(a),j,k,l,g,h,n,t=b.at,r=this.model,u=this.comparator&&null==t&&!1!==b.sort,y="string"==typeof this.comparator?this.comparator:null,p=[],v=[],
s={},x=b.add,z=b.merge,w=b.remove,q=!u&&x&&w?[]:!1;j=0;for(k=d.length;j<k;j++){h=d[j]||{};l=h instanceof e?g=h:h[r.prototype.idAttribute||"id"];if(l=this.get(l))w&&(s[l.cid]=!0),z&&(h=h===g?g.attributes:h,b.parse&&(h=l.parse(h,b)),l.set(h,b),u&&(!n&&l.hasChanged(y))&&(n=!0)),d[j]=l;else if(x){g=d[j]=this._prepareModel(h,b);if(!g)continue;p.push(g);this._addReference(g,b)}g=l||g;q&&(g.isNew()||!s[g.id])&&q.push(g);s[g.id]=!0}if(w){j=0;for(k=this.length;j<k;++j)s[(g=this.models[j]).cid]||v.push(g);
v.length&&this.remove(v,b)}if(p.length||q&&q.length)if(u&&(n=!0),this.length+=p.length,null!=t){j=0;for(k=p.length;j<k;j++)this.models.splice(t+j,0,p[j])}else{q&&(this.models.length=0);h=q||p;j=0;for(k=h.length;j<k;j++)this.models.push(h[j])}n&&this.sort({silent:!0});if(!b.silent){j=0;for(k=p.length;j<k;j++)(g=p[j]).trigger("add",g,this,b);(n||q&&q.length)&&this.trigger("sort",this,b)}return c?d[0]:d},reset:function(a,b){b||(b={});for(var c=0,d=this.models.length;c<d;c++)this._removeReference(this.models[c],
b);b.previousModels=this.models;this._reset();a=this.add(a,$HO.extend({silent:!0},b));b.silent||this.trigger("reset",this,b);return a},push:function(a,b){return this.add(a,$HO.extend({at:this.length},b))},pop:function(a){var b=this.at(this.length-1);this.remove(b,a);return b},unshift:function(a,b){return this.add(a,$HO.extend({at:0},b))},shift:function(a){var b=this.at(0);this.remove(b,a);return b},slice:function(){return Array.prototype.slice.apply(this.models,arguments)},get:function(a){return null==
a?void 0:this._byId[a]||this._byId[a.id]||this._byId[a.cid]},at:function(a){return this.models[a]},where:function(a,b){return $HO.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){this.comparator||$D.error(Error("\u6ca1\u6709\u6bd4\u8f83\u5668"));a||(a={});"string"==typeof this.comparator||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort($H.Function.bind(this.comparator,
this));a.silent||this.trigger("sort",this,a);return this},pluck:function(a){return $H.Collection.invoke(this.models,"get",a)},fetch:function(a){var b=this;a=a?$H.clone(a):{};void 0===a.parse&&(a.parse=!0);var c=a.success;a.success=function(d){b[a.reset?"reset":"set"](d,a);c&&c(b,d,a);b.trigger("sync",b,d,a)};d(b,a);return b.sync("read",b,a)},create:function(a,b){var c=this;b=b?$H.clone(b):{};if(!(a=c._prepareModel(a,b)))return!1;b.wait||c.add(a,b);var d=b.success;b.success=function(a,e){b.wait&&c.add(a,
b);d&&d(a,e,b)};a.save(null,b);return a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)}});var d;$HO.each(["some","every","find","filter","invoke"],function(a){c.prototype[a]=function(){var b=Array.prototype.slice.call(arguments),c=$H.Collection;b.unshift(this.models);return c[a].apply(c,b)}});return c});
